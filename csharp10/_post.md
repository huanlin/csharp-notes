# C# 10

**ğŸ‘‰ä»»æ„é–€**ï¼š[C# 6](https://github.com/huanlin/LearningNotes/blob/main/csharp6/_post.md#c-6) | [C# 7](https://github.com/huanlin/LearningNotes/blob/main/csharp7/_post.md#c-7) | [C# 8](https://github.com/huanlin/LearningNotes/blob/main/csharp8/_post.md#c-8)  | [C# 9](https://github.com/huanlin/LearningNotes/blob/main/csharp9/_post.md#c-9) | [C# 10](https://github.com/huanlin/LearningNotes/blob/main/csharp10/_post.md#c-10) | [é¦–é ](https://github.com/huanlin/LearningNotes#readme)

æœ¬ç« è¦ä»‹ç´¹çš„æ˜¯ C# 10 çš„æ–°å¢èªæ³•å’Œæ”¹é€²ä¹‹è™•ï¼ŒåŒ…æ‹¬ï¼š

- [File-scoped å‘½åç©ºé–“](#File-scoped-å‘½åç©ºé–“)
- [å…¨åŸŸå¼•ç”¨](#å…¨åŸŸå¼•ç”¨)
- [å­—ä¸²å¸¸æ•¸æ’è£œ](#å­—ä¸²å¸¸æ•¸æ’è£œ)
- [å·¢ç‹€å±¬æ€§æ¨£å¼](#å·¢ç‹€å±¬æ€§æ¨£å¼)
- [Lambda èªæ³•çš„æ”¹é€²](#Lambda-èªæ³•çš„æ”¹é€²)
- [åˆ†è§£å¼çš„æ”¹é€²](#åˆ†è§£å¼çš„æ”¹é€²)
- [è¨˜éŒ„çš„æ”¹é€²](#è¨˜éŒ„çš„æ”¹é€²)
- [çµæ§‹çš„æ”¹é€²](#çµæ§‹çš„æ”¹é€²)
- [åŒ¿åå‹åˆ¥çš„éç ´å£å¼è®Šå½¢](#åŒ¿åå‹åˆ¥çš„éç ´å£å¼è®Šå½¢)
- [å­—ä¸²æ’è£œçš„æ•ˆèƒ½æ”¹é€²](#å­—ä¸²æ’è£œçš„æ•ˆèƒ½æ”¹é€²)
- [`CallerArgumentExpression` ç‰¹å¾µé …](#CallerArgumentExpression-ç‰¹å¾µé …)
- [`AsyncMethodBuilder` ç‰¹å¾µé …å¯å¥—ç”¨è‡³æ–¹æ³•](#AsyncMethodBuilder-ç‰¹å¾µé …å¯å¥—ç”¨è‡³æ–¹æ³•)
- [å…¶ä»–æ”¹é€²](#å…¶ä»–æ”¹é€²)

**æ³¨æ„**ï¼š.NET 6 æˆ–å¾ŒçºŒç‰ˆæœ¬æ‰æœ‰æ”¯æ´ C# 10ã€‚æœ¬ç« è‹¥æœ‰æåŠ Visual Studioï¼Œçš†æ˜¯æŒ‡ Visual Studio 2022ã€‚

---

## File-scoped å‘½åç©ºé–“

C# 10 æ–°å¢äº† file-scoped namespace èªæ³•ï¼Œä¸­æ–‡è­¯ä½œã€Œæª”æ¡ˆç¯„åœçš„å‘½åç©ºé–“å®£å‘Šã€ã€‚å¾€å¾ŒæåŠæ­¤èªæ³•æ™‚ï¼Œå¤§å¤šæœƒä½¿ç”¨è‹±æ–‡ file-scopedã€‚

File-scoped å‘½åç©ºé–“å®£å‘Šåªè¦å¯«ä¸€è¡Œï¼Œå°±å¯ä»¥è®“æ•´å€‹æª”æ¡ˆè£¡é¢çš„å‹åˆ¥å…¨éƒ½éš¸å±¬åœ¨æŒ‡å®šçš„å‘½åç©ºé–“è£¡ã€‚å…‰ç”¨ç™½è©±è§£é‡‹ææ€•ä¸å¥½ç†è§£ï¼Œçœ‹ç¨‹å¼ç¢¼æœƒæ›´æ¸…æ¥šã€‚ä»¥å¾€éƒ½æ˜¯ä»¥ä¸€å°å¤§æ‹¬è™Ÿä¾†ç•Œå®šä¸€å€‹å‘½åç©ºé–“çš„æœ‰æ•ˆç¯„åœï¼Œä¾‹å¦‚ï¼š

~~~~~~~~csharp
namespace Models
{
    class Employee {  }
    class Customer {  }
}
~~~~~~~~

åœ¨ C# 10 å¯ä»¥é€™æ¨£å¯«ï¼š

~~~~~~~~csharp
namespace Models;  // å®£å‘Šæ•´å€‹æª”æ¡ˆç¯„åœçš„å‘½åç©ºé–“

class Employee {  }  
class Customer {  }
~~~~~~~~

é¡¯è€Œæ˜“è¦‹ï¼Œé€™å€‹ file-scoped å‘½åç©ºé–“èªæ³•çš„å¥½è™•æ˜¯å¯ä»¥è®“æˆ‘å€‘çš„ç¨‹å¼ç¢¼æ¸›å°‘ä¸€å±¤ç¸®æ’ã€‚

Visual Studio ç·¨è¼¯å™¨çš„é è¨­å€¼æ˜¯ã€ŒBlock scopedã€ã€‚ä½ å¯ä»¥ç‚º solution åŠ å…¥ä¸€å€‹ EditorConfig æª”æ¡ˆï¼Œä¸¦å°‡å…¶ä¸­çš„ã€Œnamespace declarationsã€è¨­å®šæ”¹ç‚ºã€ŒFile scopedã€ã€‚å¦‚æ­¤ä¸€ä¾†ï¼Œä»¥å¾Œåœ¨æ­¤å°ˆæ¡ˆä¸­æ–°åŠ å…¥çš„ C# æª”æ¡ˆï¼Œå…¶å‘½åç©ºé–“å°±æœƒæ˜¯ file-scoped å¯«æ³•ã€‚è¨­å®š EditorConfig æª”æ¡ˆçš„æ“ä½œæ­¥é©Ÿå¯åƒè€ƒä¸‹åœ–ï¼ˆGIF å‹•ç•«ï¼‰ï¼š

![](images/vs2022-editorconfig.gif)

## å…¨åŸŸå¼•ç”¨

ç•¶æˆ‘å€‘åœ¨ Visual Studio ä¸­å»ºç«‹ä¸€å€‹æ–°çš„ Console æ‡‰ç”¨ç¨‹å¼å°ˆæ¡ˆï¼Œç›®æ¨™æ¡†æ¶é¸æ“‡ .NET 6ï¼Œä¸¦æ¡ç”¨é è¨­çš„å°ˆæ¡ˆåç¨± ConsoleApp1ï¼Œå°ˆæ¡ˆå»ºç«‹å®Œæˆå¾Œï¼Œå¯ä»¥çœ‹åˆ° Program.cs æª”æ¡ˆè£¡é¢åªæœ‰ä¸€è¡Œç¨‹å¼ç¢¼ï¼Œå¤–åŠ ä¸€è¡Œè¨»è§£ï¼š
 
    // See https://aka.ms/new-console-template for more information
    Console.WriteLine("Hello, World!");

ç¨‹å¼è£¡é¢ä½¿ç”¨äº† `Console.WriteLine(...)` å»æ²’æœ‰ `using System` å‘½åç©ºé–“ï¼Œé€™æ˜¯ä½¿ç”¨äº† .NET 6 çš„ã€Œéš±å«å¼•ç”¨ã€ï¼ˆimplicit usingï¼‰åŠŸèƒ½ã€‚é‚£éº¼ï¼Œé€™äº›éš±å«å¼•ç”¨çš„å‘½åç©ºé–“æ˜¯éš±è—åœ¨å“ªè£¡å‘¢ï¼Ÿ

é–‹å•Ÿå°ˆæ¡ˆçš„ .csproj æª”æ¡ˆï¼Œæ‡‰è©²æœƒçœ‹åˆ°è£¡é¢æœ‰ä¸€å€‹ `<ImplicitUsings>` å…ƒç´ ï¼š

~~~~~~~~xml
<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <OutputType>Exe</OutputType>
    <TargetFramework>net6.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
  </PropertyGroup>
</Project>
~~~~~~~~

ç¬¬ 5 è¡Œçš„ `<ImplicitUsings>` å…ƒç´ å°±æ˜¯ç”¨ä¾†æ§åˆ¶è©²å°ˆæ¡ˆæ˜¯å¦é–‹å•Ÿã€Œéš±å«å¼•ç”¨ã€çš„é–‹é—œï¼Œé è¨­ç‚ºé–‹å•Ÿï¼ˆ`enable`ï¼‰ã€‚

æ–¼æ˜¯ï¼Œç·¨è­¯å°ˆæ¡ˆæ™‚ï¼Œå°±æœƒåœ¨å°ˆæ¡ˆç›®éŒ„ä¸‹çš„ã€Œobj\Debug\ç›®æ¨™æ¡†æ¶\ã€åº•ä¸‹è‡ªå‹•ç”¢ç”Ÿä¸€å€‹åç‚º *[å°ˆæ¡ˆåç¨±]*.GlobalUsings.g.cs çš„æª”æ¡ˆã€‚å¦‚ä¸‹åœ–ï¼š
 
![](images/implicit-usings-file.png)
 
é–‹å•Ÿé€™å€‹ *[å°ˆæ¡ˆåç¨±]*.GlobalUsings.g.cs æª”æ¡ˆï¼Œä¾¿å¯ä»¥çœ‹åˆ°é¡ä¼¼åº•ä¸‹çš„å…§å®¹ï¼š

~~~~~~~~csharp
// <auto-generated/>
global using global::System;
global using global::System.Collections.Generic;
global using global::System.IO;
global using global::System.Linq;
global using global::System.Net.Http;
global using global::System.Threading;
global using global::System.Threading.Tasks;
~~~~~~~~
 
æ¯è¡Œç¨‹å¼ç¢¼é–‹é ­çš„ `global using` æ˜¯ C# 10 æ–°å¢çš„å…¨åŸŸå¼•ç”¨èªæ³•ï¼Œè€Œä¸Šé¢çš„ç¨‹å¼ç‰‡æ®µè£¡é¢ç¸½å…±æœ‰ä¸ƒå€‹å…¨åŸŸå¼•ç”¨çš„å‘½åç©ºé–“ï¼Œé€™è¡¨ç¤ºä¸åƒ… `Console` é¡åˆ¥ï¼ŒåŒ…å« `File`ã€`HttpClient`ã€`Thread` ç­‰é¡åˆ¥ä¹Ÿéƒ½ä¸ç”¨åœ¨å…¶ä»– .cs æª”æ¡ˆä¸­å¼•ç”¨å°æ‡‰çš„å‘½åç©ºé–“ï¼Œå³å¯ç›´æ¥ä½¿ç”¨ã€‚å¦‚æ­¤ä¸€ä¾†ï¼Œä¾¿å¯ç¯€çœä¸€äº›é‡è¤‡æ‰“å­—çš„æ™‚é–“ã€‚

å€¼å¾—ä¸€æçš„æ˜¯ï¼Œä¸Šåˆ—ç¨‹å¼ç¢¼ç‰‡æ®µä¸­çš„ `global::` æŒ‡ç¤ºè©æ˜¯åœ¨å‘Šè¨´ç·¨è­¯å™¨ï¼šå…¶å¾Œé¢è·Ÿè‘—çš„å‘½åç©ºé–“æ˜¯å…¨åŸŸï¼ˆæœ€ä¸Šå±¤ï¼‰çš„å‘½åç©ºé–“ï¼Œè«‹ä¸è¦è§£ææˆç‰¹å®šå‘½åç©ºé–“åº•ä¸‹çš„å­å‘½åç©ºé–“ã€‚é€™å€‹æŒ‡ç¤ºè©ä¸¦éå¿…è¦ï¼Œä½†å¦‚æœç¢°åˆ°å‘½åç©ºé–“è¡çªçš„æƒ…å½¢ï¼Œä¾¿å¯ä»¥ä½¿ç”¨å‘½åç©ºé–“åˆ¥åè¾¨è­˜ç¬¦è™Ÿ `::` ä¾†è§£æ±ºã€‚

å‰›æ‰å±•ç¤ºçš„ç¨‹å¼ç‰‡æ®µæ˜¯ä¾†è‡ªé è¨­çš„ Console å°ˆæ¡ˆæ¨¡æ¿ï¼Œå¦‚æœæ˜¯å…¶ä»–é¡å‹çš„å°ˆæ¡ˆæ¨¡æ¿ï¼Œå‰‡æœƒçœ‹åˆ°ä¸åŒçš„å…§å®¹ã€‚ä¾‹å¦‚åº•ä¸‹æ˜¯å»ºç«‹ Blazor Server å°ˆæ¡ˆæ™‚è‡ªå‹•ç”¢ç”Ÿçš„ .GlobalUsings.g.cs æª”æ¡ˆçš„å…§å®¹ï¼š

~~~~~~~~csharp
// <auto-generated/>
global using global::Microsoft.AspNetCore.Builder;
global using global::Microsoft.AspNetCore.Hosting;
global using global::Microsoft.AspNetCore.Http;
global using global::Microsoft.AspNetCore.Routing;
global using global::Microsoft.Extensions.Configuration;
global using global::Microsoft.Extensions.DependencyInjection;
global using global::Microsoft.Extensions.Hosting;
global using global::Microsoft.Extensions.Logging;
global using global::System;
global using global::System.Collections.Generic;
global using global::System.IO;
global using global::System.Linq;
global using global::System.Net.Http;
global using global::System.Net.Http.Json;
global using global::System.Threading;
global using global::System.Threading.Tasks;
~~~~~~~~
 
ç¾åœ¨æˆ‘å€‘çŸ¥é“äº†ï¼ŒåŸä¾†ã€Œéš±å«å¼•ç”¨ã€é€™é …åŠŸèƒ½ï¼ŒèƒŒå¾Œå…¶å¯¦ä½¿ç”¨äº†ä¸€ç¨®å«åš `global using` çš„èªæ³•ã€‚é‚£éº¼ï¼Œæˆ‘å€‘æ˜¯å¦å¯ä»¥ã€Œæ£„æš—æŠ•æ˜ã€ï¼Œåœ¨è‡ªå·±çš„å°ˆæ¡ˆè£¡é¢æ˜ç™½åœ°æ’°å¯«é€™äº›ã€Œå…¨åŸŸå¼•ç”¨ã€å‘¢ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ã€‚
 
### ä½¿ç”¨ C# æª”æ¡ˆä¾†ç®¡ç†å…¨åŸŸå¼•ç”¨
 
æˆ‘å€‘å¯ä»¥ä½¿ç”¨ä¸€å€‹ C# æª”æ¡ˆä¾†é›†ä¸­ç®¡ç† `global using` èªå¥ï¼Œå…·é«”ä½œæ³•å¦‚ä¸‹ã€‚
 
é¦–å…ˆï¼Œé–‹å•Ÿå°ˆæ¡ˆçš„ .csproj æª”æ¡ˆï¼ŒæŠŠ `<ImplicitUsings>enable</ImplicitUsings>` æ•´è¡Œåˆªé™¤ï¼Œæˆ–å°‡å…¶å±¬æ€§å€¼æ”¹ç‚º `disable`ã€‚ä¹Ÿå°±æ˜¯èªªï¼Œä¸è¦ä½¿ç”¨ Visual Studio å°ˆæ¡ˆç¯„æœ¬æ‰€æä¾›çš„é‚£äº›é è¨­çš„å…¨åŸŸå‘½åç©ºé–“ã€‚
 
æ¥è‘—åœ¨å°ˆæ¡ˆä¸­åŠ å…¥ä¸€å€‹ C# æª”æ¡ˆï¼Œé€šå¸¸å‘½åç‚º GlobalUsings.csã€‚ç„¶å¾Œåªè¦åœ¨é€™å€‹æª”æ¡ˆè£¡é¢ä½¿ç”¨ `global using` ä¾†åŠ å…¥ä½ æƒ³è¦å¥—ç”¨è‡³æ•´å€‹å°ˆæ¡ˆçš„å‘½åç©ºé–“å°±è¡Œäº†ã€‚åƒè€ƒä¸‹åœ–ï¼š

![](images/global-using-ide.png)

åœ¨åŒä¸€å€‹ C# æª”æ¡ˆè£¡é¢å¯ä»¥åŒæ™‚æœ‰ `using` å’Œ `global using` èªå¥ï¼Œä½† `global using` å¿…é ˆå¯«åœ¨ `using` ä¹‹å‰ï¼Œå¦å‰‡ç„¡æ³•é€šéç·¨è­¯ã€‚ä¾‹å¦‚ï¼š

~~~~~~~~csharp
using System.IO;
global using System; // ç·¨è­¯å¤±æ•—! 
~~~~~~~~

é †ä¾¿æåŠï¼Œå¾ C# 6 é–‹å§‹æä¾›çš„ [`using static`](https://github.com/huanlin/LearningNotes/blob/main/csharp6/_post.md#using-static-%E9%99%B3%E8%BF%B0%E5%BC%8F) ä¹ŸåŒæ¨£å¯ä»¥è®“æˆ‘å€‘å°‘æ‰“ä¸€äº›å­—ï¼Œä½†å…¶é©ç”¨å°è±¡ç‚ºã€Œéœæ…‹æˆå“¡ã€ã€‚å®ƒä¹Ÿå¯ä»¥è·Ÿ `global using` æ­é…é‹ç”¨ï¼Œä¾‹å¦‚ï¼š

~~~~~~~~csharp
global using System;
global using static System.Console;
~~~~~~~~

- ç¬¬ 1 è¡Œï¼šæ•´å€‹å°ˆæ¡ˆçš„ C# æª”æ¡ˆéƒ½ä¸ç”¨å†æ’°å¯« `using System`ï¼Œä¾¿å¯ä½¿ç”¨è©²å‘½åç©ºé–“åº•ä¸‹çš„æ‰€æœ‰å‹åˆ¥ã€‚
- ç¬¬ 2 è¡Œï¼šæ•´å€‹å°ˆæ¡ˆçš„ C# æª”æ¡ˆéƒ½å¯ä»¥ç›´æ¥ä½¿ç”¨ `System.Console` é¡åˆ¥çš„æ‰€æœ‰éœæ…‹æˆå“¡ï¼Œä¾‹å¦‚ï¼š`WriteLine("Hello")`ã€‚

### é€éå°ˆæ¡ˆæª”ä¾†ç®¡ç†å…¨åŸŸå¼•ç”¨

é™¤äº†ä½¿ç”¨å‰›æ‰ç¤ºç¯„çš„ GlobalUsings.cs æª”æ¡ˆï¼Œæˆ‘å€‘ä¹Ÿå¯ä»¥åœ¨ .csproj è£¡é¢ä½¿ç”¨ `<Using>` å…ƒç´ ä¾†å¢åŠ æˆ–ç§»é™¤å…¨åŸŸçš„å‘½åç©ºé–“ã€‚åƒè€ƒä»¥ä¸‹ç¯„ä¾‹ï¼š
 
~~~~~~~~xml
<Project Sdk="Microsoft.NET.Sdk">
    <PropertyGroup>
        <OutputType>Exe</OutputType>
        <TargetFramework>net6.0</TargetFramework>
        <ImplicitUsings>enable</ImplicitUsings>
        <Nullable>enable</Nullable>
    </PropertyGroup>
    
    <ItemGroup>
      <Using Include="MyLib.Extensions" />
      <Using Remove="System.Net.Http" />
    </ItemGroup>    
</Project>
~~~~~~~~

èªªæ˜ï¼š

- ç¬¬ 5 è¡Œï¼š`<ImplicitUsings>` ç‚º `enable`ï¼Œè¡¨ç¤ºè¦ä½¿ç”¨ .NET SDK çš„éš±å«å¼•ç”¨åŠŸèƒ½ä¾†è‡ªå‹•ç”¢ç”Ÿç¨æ—©æéçš„ *[å°ˆæ¡ˆåç¨±]*.GlobalUsings.g.cs æª”æ¡ˆã€‚
- ç¬¬ 11 è¡Œï¼šæŠŠ `MyLib.Extensions` åŠ å…¥å…¨åŸŸå¼•ç”¨åå–®ã€‚
- ç¬¬ 12 è¡Œï¼šæŠŠ `System.Net.Http` å¾å…¨åŸŸå¼•ç”¨åå–®ä¸­ç§»é™¤ã€‚ä¹Ÿå°±æ˜¯èªªï¼Œå¦‚æœ `<ImplicitUsings>` æ‰€ç”¢ç”Ÿçš„å…¨åŸŸå¼•ç”¨åå–®è£¡é¢æœ‰ `System.Net.Http`ï¼Œä¾¿å°‡å®ƒç§»é™¤ã€‚

> æˆ‘å€‹äººä¸æ˜¯å¾ˆå–œæ­¡ç·¨è¼¯ XMLï¼Œæ‰€ä»¥åå¥½ä½¿ç”¨ä¸€å€‹ C# æª”æ¡ˆä¾†ç®¡ç†æ•´å€‹å°ˆæ¡ˆçš„ `global using` èªå¥ã€‚ä¸€æ—¦ç™¼ç”Ÿå‘½åç©ºé–“è¡çªï¼Œæˆ–æœ‰ä»»ä½•ç–‘æ…®æ™‚ï¼Œåªè¦æ‰“é–‹æˆ‘å»ºç«‹çš„é‚£å€‹ GlobalUsings.cs æª”æ¡ˆï¼Œä¾¿å¯ä¸€ç›®ç­ç„¶ã€‚

**é‡é»æ•´ç†ï¼š**

- `global using`ï¼ˆå…¨åŸŸå¼•ç”¨ï¼‰æ˜¯ C# 10 æ–°å¢çš„èªæ³•ï¼Œå…¶ç”¨é€”æ˜¯å°‡æŒ‡å®šçš„å‘½åç©ºé–“å¥—ç”¨æ–¼æ•´å€‹å°ˆæ¡ˆã€‚å¦‚æ­¤ä¸€ä¾†ï¼Œé‚£äº›å¸¸ç”¨çš„å‘½åç©ºé–“å¯ä»¥åªå¯«ä¸€æ¬¡ `using` èªå¥ï¼Œè€Œä¸ç”¨åœ¨æ¯ä¸€å€‹ C# æª”æ¡ˆè£¡é¢é‡è¤‡å¯«ã€‚
- å°ˆæ¡ˆçš„ .csproj æª”æ¡ˆä¸­çš„ `<ImplicitUsings>` å¯ç”¨ä¾†æ§åˆ¶æ˜¯å¦å•Ÿç”¨ .NET SDK çš„ã€Œéš±å«å¼•ç”¨ã€åŠŸèƒ½ã€‚è‹¥å•Ÿç”¨ï¼Œç·¨è­¯å°ˆæ¡ˆçš„æ™‚å€™å°±æœƒè‡ªå‹•ç”¢ç”Ÿä¸€å€‹åç‚º *[å°ˆæ¡ˆåç¨±]*.GlobalUsings.g.cs çš„æª”æ¡ˆï¼Œè£¡é¢æœ‰ä¸€äº›å¸¸ç”¨å‘½åç©ºé–“çš„ `global using` èªå¥ã€‚æ­¤å¤–ï¼Œ.csproj æª”æ¡ˆè£¡é¢ä¹Ÿå¯ä»¥é€é `<Using>` å…ƒç´ ä¾†å¢åŠ æˆ–ç§»é™¤å…¨åŸŸå¼•ç”¨çš„å‘½åç©ºé–“ã€‚
- æˆ‘å€‘ä¹Ÿå¯ä»¥ç”¨ä¸€å€‹ C# æª”æ¡ˆä¾†é›†ä¸­ç®¡ç†å…¨åŸŸå¼•ç”¨çš„å‘½åç©ºé–“ã€‚
- å…¨åŸŸå¼•ç”¨çš„æœ‰æ•ˆç¯„åœæ˜¯ã€Œé€™å€‹å°ˆæ¡ˆã€ã€‚æ›è¨€ä¹‹ï¼ŒA å°ˆæ¡ˆè£¡é¢çš„ `global using` èªå¥ä¸æœƒå½±éŸ¿åˆ° B å°ˆæ¡ˆæˆ–å…¶ä»–å°ˆæ¡ˆã€‚

## å­—ä¸²å¸¸æ•¸æ’è£œ

C# 9 ä¸å…è¨±å­—ä¸²å¸¸æ•¸ä½¿ç”¨å­—ä¸²æ’è£œï¼ˆstring interpolationï¼Œæˆ–ã€Œå­—ä¸²æ’å€¼ã€ï¼‰ï¼Œä¾‹å¦‚ï¼š

~~~~~~~~csharp
const string AppName = "æˆ‘çš„ç¨‹å¼";
const string Version = "1.0";
const string ProductName = $"{AppName} {VersionName}";
~~~~~~~~

ç¬¬ 3 è¡Œåœ¨ C# 9 ç„¡æ³•é€šéç·¨è­¯ï¼Œå¾ C# 10 é–‹å§‹å‰‡æ²’æœ‰å•é¡Œã€‚

## å·¢ç‹€å±¬æ€§æ¨£å¼

åœ¨æ¨£å¼æ¯”å°çš„éƒ¨åˆ†ï¼ŒC# 10 é‡å°å·¢ç‹€å±¬æ€§çš„å¯«æ³•æœ‰äº†é€²ä¸€æ­¥ç°¡åŒ–ã€‚å…ˆä¾†çœ‹ä¸€å€‹æ²’æœ‰ä½¿ç”¨æ¨£å¼æ¯”å°çš„ä¾‹å­ï¼š

~~~~~~~~csharp
var obj = new Uri("https://www.huanlintalk.com");
if (obj?.Scheme?.Length == 5 && obj?.Segments?.Length > 0)
{
    ...
}
~~~~~~~~

åœ¨ C# 10 ä¹‹å‰ï¼Œå¦‚æœè¦æ”¹ç”¨æ¨£å¼æ¯”å°èªæ³•ï¼Œæœƒé€™æ¨£å¯«ï¼š

~~~~~~~~csharp
if (obj is Uri { Scheme: { Length: 5 }, Segments: { Length: > 0 } })
~~~~~~~~

çµæœæ¯”åŸæœ¬æ²’æœ‰æ¨£å¼æ¯”å°çš„å¯«æ³•é‚„è¦å›‰å—¦ï¼é‚„å¥½ C# 10 é‡å°å·¢ç‹€å±¬æ€§çš„èªæ³•åšäº†ç°¡åŒ–ï¼Œå¯ä»¥å¯«æˆï¼š

~~~~~~~~csharp
if (obj is Uri { Scheme.Length: 5, Segments.Length: > 0 }) 
~~~~~~~~

äº‹å¯¦ä¸Šï¼Œé‚„å¯ä»¥å†ç°¡åŒ–ä¸€é»é»ï¼ŒæŠŠå‹åˆ¥çœç•¥ï¼š

~~~~~~~~csharp
if (obj is { Scheme.Length: 5, Segments.Length: > 0 }) 
~~~~~~~~

é€™æ¨£å°±çœŸçš„æ¯”è¼ƒç°¡æ½”äº†ã€‚å‰›æ‰çš„æœ€å¾Œå…©å€‹ä½¿ç”¨å·¢ç‹€å±¬æ€§çš„å¯«æ³•ï¼Œç·¨è­¯å™¨æœƒå¹«æˆ‘å€‘è½‰è­¯æˆé¡ä¼¼åº•ä¸‹çš„ç¨‹å¼ç¢¼ï¼Œå¯ä»¥çœ‹åˆ°æ‰€æœ‰å¿…è¦çš„ null æª¢æŸ¥éƒ½å¹«æˆ‘å€‘è™•ç†äº†ï¼š

~~~~~~~~csharp
if (obj != null)
{
    string scheme = obj.scheme;
    if (scheme != null && scheme.Length == 5)
    {
        string[] segments = obj.Segments;
        if (segments != null)
        {
            if (segments.Length > 0) 
            {
                // è‡³æ­¤å…¨éƒ¨çš„æ¯”å°æ¢ä»¶æˆç«‹
            }
        }
    }
}
~~~~~~~~

æœ€å¾ŒæŠŠå‰é¢å¹¾å€‹ç¯„ä¾‹æ•´ç†æˆä¸€å¼µåœ–ï¼Œæ–¹ä¾¿å¿«é€Ÿè¤‡ç¿’ï¼š

![](images/nested-property-pattern.png)

## Lambda èªæ³•çš„æ”¹é€²

C# 10 çš„ lambda èªæ³•æœ‰å¹¾è™•æ”¹é€²ï¼Œé¦–å…ˆè¦ä»‹ç´¹çš„æ˜¯**è‡ªå‹•æ¨æ–·å§”æ´¾å‹åˆ¥**ï¼ˆinferred delegate typeï¼‰ã€‚ç¯„ä¾‹ï¼š

~~~~~~~~csharp
Func<string> hello = () => "Hello World"; 
Console.WriteLine(hello());
~~~~~~~~

æ­¤ç¯„ä¾‹åœ¨ C# 9 å¯ä»¥é€šéç·¨è­¯ã€‚åˆ°äº† C# 10ï¼Œå‰‡å› ç‚ºç·¨è­¯å™¨èƒ½å¤ è‡ªå‹•æ¨æ–·å§”æ´¾å‹åˆ¥è€Œå¯ä»¥ä½¿ç”¨ `var` ä¾†å®£å‘Šå§”æ´¾è®Šæ•¸ï¼Œåƒé€™æ¨£ï¼š

~~~~~~~~csharp
var hello = () => "Hello World"; // C# 9 ç„¡æ³•ç·¨è­¯!
~~~~~~~~

å¦‚æœå§”æ´¾çš„å›å‚³å€¼ç‚º nullï¼Œç·¨è­¯å™¨è‡ªç„¶ç„¡æ³•åˆ¤å®šä½ æƒ³å›å‚³ä»€éº¼å‹åˆ¥ï¼Œä¾‹å¦‚ï¼š

~~~~~~~~csharp
var hello = () => null; // ç„¡æ³•ç·¨è­¯!
~~~~~~~~

æ­¤æ™‚å¦‚æœé‚„æ˜¯æƒ³è¦ç”¨ `var` ä¾†å®£å‘Šè®Šæ•¸å‹åˆ¥ï¼Œå‰‡å¯ä»¥åœ¨æ’°å¯« lambda è¡¨é”å¼çš„æ™‚å€™å®£å‘Šå›å‚³å‹åˆ¥ï¼š

~~~~~~~~csharp
var hello = string? () => null; // OK!
~~~~~~~~

ç•¶ä½ çš„ç¨‹å¼æœ‰å¾ˆè¤‡é›œçš„å·¢ç‹€ lambda èªå¥ï¼Œä¾¿å¯ä½¿ç”¨é€™ç¨®æ˜ç¢ºå®£å‘Šå›å‚³å‹åˆ¥çš„æ–¹å¼ä¾†æ¸›è¼•ç·¨è­¯å™¨æ¨æ–·å‹åˆ¥çš„è² æ“”ï¼Œå¾è€ŒåŠ å¿«ç·¨è­¯é€Ÿåº¦ã€‚é€™æ˜¯ lambda èªæ³•çš„ç¬¬äºŒé …æ”¹é€²ã€‚

ç¬¬ä¸‰é …æ”¹é€²æ˜¯ç•¶æˆ‘å€‘æŠŠ lambda è¡¨é”å¼å‚³å…¥æŸæ–¹æ³•çš„åƒæ•¸æ™‚ï¼Œåƒæ•¸å‹åˆ¥å¯ä»¥æ˜¯ `object`ã€`Delegate`ã€æˆ– `Expression`ï¼š

~~~~~~~~csharp
M1(() => "test"); // Func<string>
M2(() => "test"); // Func<string>
M3(() => "test"); // Expression<Func<string>>

void M1(object x) { }
void M2(Delegate x) { }
void M3(Expression x) { }
~~~~~~~~

åœ¨ C# 9ï¼Œç¬¬ 1 è¡Œè‡³ç¬¬ 3 è¡Œéƒ½ç„¡æ³•é€šéç·¨è­¯ï¼ˆç„¡æ³•å°‡ lambda è¡¨é”å¼è½‰æ›æˆç›®æ¨™åƒæ•¸å‹åˆ¥ï¼‰ï¼ŒC# 10 å‰‡æ²’æœ‰å•é¡Œã€‚

æœ€å¾Œä¸€é …æ”¹é€²æ˜¯ï¼Œlambda è¡¨é”å¼å¾ç¾åœ¨é–‹å§‹å¯ä»¥å¥—ç”¨ç‰¹å¾µé …ï¼ˆattributeï¼‰ï¼ŒåŒ…æ‹¬åŒ¿åæ–¹æ³•ã€æ–¹æ³•åƒæ•¸ã€ä»¥åŠå›å‚³å€¼ï¼Œçš†å¯å¥—ç”¨ã€‚ç¯„ä¾‹ï¼š

~~~~~~~~csharp
var fn1 = [Description("æ˜¯åœ¨å“ˆå›‰")] () => "Hello";
var fn2 = ([Description("åƒæ•¸") string s) => "Hello " + s;
var fn3 = [Description("æ˜¯åœ¨å“ˆå›‰")] 
          [return: Description("å›å‚³å­—ä¸²")]
          ([Description("åƒæ•¸")] string s) => "Hello " + s;
~~~~~~~~

èªªæ˜ï¼š

1. ç‚º `fn1` çš„åŒ¿åæ–¹æ³•å¥—ç”¨ DescriptionAttributeï¼Œä¹Ÿå°±æ˜¯æ›¿æ–¹æ³•åŠ ä¸Šèªªæ˜æ–‡å­—ã€‚
2. ç‚º `fn2` çš„åŒ¿åæ–¹æ³•åŠ ä¸Šåƒæ•¸çš„èªªæ˜æ–‡å­—ã€‚
3. ç‚º `fn3` çš„åŒ¿åæ–¹æ³•ã€åƒæ•¸ã€å›å‚³å‹åˆ¥éƒ½åŠ ä¸Šèªªæ˜æ–‡å­—ã€‚

ä½¿ç”¨æ™‚æ©Ÿï¼šæŸäº› API æœƒå»åˆ¤æ–·å‚³å…¥çš„å§”æ´¾æ–¹æ³•æ˜¯å¦å¥—ç”¨äº†æŸäº›ç‰¹å¾µé …è€Œæœ‰ä¸åŒçš„è¡Œç‚ºï¼Œæ­¤æ™‚ä¾¿å¯ä½¿ç”¨ C# 10 æ–°å¢çš„ lambda ç‰¹å¾µé …èªæ³•ä¾†æ’°å¯«åŒ¿åæ–¹æ³•ï¼Œè€Œä¸ç”¨åƒä»¥å‰é‚£æ¨£éå¾—æ’°å¯«å…·åæ–¹æ³•ä¸å¯ã€‚

## åˆ†è§£å¼çš„æ”¹é€²

é–±è®€ä»¥ä¸‹ç¨‹å¼ç‰‡æ®µï¼š

~~~~~~~~csharp
var student = (Id: 1, Name: "Mike"); // tuple
(int id, string name) = student;     // åˆ†è§£
Console.WriteLine($"{id}-{name}"); // "1-Mike"
~~~~~~~~

ç¬¬ 1 è¡Œç¨‹å¼ç¢¼å»ºç«‹äº†ä¸€å€‹ tupleï¼Œæ¥è‘—ç¬¬ 2 è¡Œå°‡æ­¤ tuple åˆ†è§£ç‚ºå…©å€‹è®Šæ•¸ `id` å’Œ `name`ã€‚åœ¨ C# 10 ä¹‹å‰ï¼Œç¬¬ 2 è¡Œç”¨ä¾†æ‰¿æ¥åˆ†è§£çµæœçš„è®Šæ•¸å¿…é ˆå…¨éƒ¨å®£å‘Šåœ¨ä¸€å°æ‹¬å¼§è£¡é¢ã€‚åˆ°äº† C# 10ï¼Œæ­¤é™åˆ¶è¢«æ”¾å¯¬äº†ï¼Œå¯ä»¥é€™æ¨£å¯«ï¼š

~~~~~~~~csharp
string name; 
var student = (Id: 1, Name: "Mike");
(int id, name) = student; // C# 9 ç·¨è­¯å¤±æ•—ï¼ŒC# 10 OK!
~~~~~~~~

ä¹Ÿå°±æ˜¯èªªï¼Œç‰©ä»¶åˆ†è§£çš„çµæœå¯ä»¥å…¨éƒ¨å®£å‘Šåœ¨ä¸€å°æ‹¬å¼§ä¸­ï¼Œä¹Ÿå¯ä»¥æ··åˆå…¶ä»–è®Šæ•¸ã€‚

## è¨˜éŒ„çš„æ”¹é€²

è¨˜éŒ„ï¼ˆrecordï¼‰æ˜¯å¾ C# 9 é–‹å§‹æä¾›ï¼Œè€Œ C# 10 æœ‰å…©è™•å¼·åŒ–ï¼š

1. å®£å‘Šè¨˜éŒ„é¡å‹æ™‚ï¼Œå¯æ˜ç¢ºæŒ‡å®šä»¥çµæ§‹ï¼ˆstructï¼‰ä½œç‚ºçœŸå¯¦å‹åˆ¥ã€‚
2. åœ¨è¨˜éŒ„ä¸­æ”¹å¯« `ToString` æ–¹æ³•æ™‚ï¼Œå¯å°‡å…¶å¯†å°ï¼ˆsealedï¼‰ï¼Œä»¥é¿å…å…¶ä»–äººâ€”â€”å°¤å…¶æ˜¯ç·¨è­¯å™¨â€”â€”æ”¹å¯«æ­¤æ–¹æ³•ã€‚

æ¥è‘—å°æ­¤å…©è™•å¼·åŒ–åŠŸèƒ½é€²ä¸€æ­¥èªªæ˜ã€‚

> ä»¥ä¸‹å…§å®¹éœ€è¦å…·å‚™ `record` åŸºç¤çŸ¥è­˜ï¼Œæ‰æ¯”è¼ƒå¥½ç†è§£ã€‚å¯åƒé–± [C# 9 çš„ã€ˆè¨˜éŒ„ã€‰](https://github.com/huanlin/LearningNotes/blob/main/csharp9/_post.md#%E8%A8%98%E9%8C%84)ä¸€ç¯€çš„èªªæ˜ã€‚

### ä»¥çµæ§‹å¯¦ä½œçš„è¨˜éŒ„

è¨˜éŒ„ï¼ˆrecordï¼‰é¡å‹æ˜¯å¾ C# 9 é–‹å§‹æä¾›ï¼Œå…¶ç·¨è­¯å¾Œçš„ç¨‹å¼ç¢¼æ˜¯ä»¥**é¡åˆ¥**çš„å½¢å¼å­˜åœ¨ï¼Œæ‰€ä»¥æ˜¯åƒè€ƒå‹åˆ¥ã€‚

C# 10 æ–°å¢äº† `record struct` èªæ³•ï¼Œè®“æˆ‘å€‘èƒ½å¤ æŒ‡å®šä½¿ç”¨**çµæ§‹**ä¾†ä½œç‚ºå¯¦éš›å‹åˆ¥ã€‚ä¾‹å¦‚ï¼š

~~~~~~~~csharp
public record struct Point(int X, int Y);
~~~~~~~~

é€™è£¡ä½¿ç”¨äº†æ¯”è¼ƒç°¡æ½”çš„ã€Œä½ç½®åƒæ•¸ã€èªæ³•ä¾†å®šç¾© `Point` è¨˜éŒ„ã€‚ä»¥æ­¤æ–¹å¼å®šç¾©çš„è¨˜éŒ„é¡å‹ï¼Œå¯¦éš›ä¸Šæœƒè¢«ç·¨è­¯æˆé¡ä¼¼åº•ä¸‹çš„ç¨‹å¼ç¢¼ï¼š

~~~~~~~~csharp
public struct Point : IEquatable<Point>
{
	public int X { get; set; }
	public int Y { get; set; }
    ... å…¶é¤˜çœç•¥
}
~~~~~~~~

**è§€å¯Ÿé‡é» 1**ï¼šæ­¤è¨˜éŒ„é¡å‹æ˜¯ä»¥çµæ§‹ä¾†å¯¦ç¾ï¼ˆç¬¬ 1 è¡Œï¼‰ï¼Œæ‰€ä»¥å®ƒæ˜¯å€‹å¯¦è³ªå‹åˆ¥ï¼Œè€Œéåƒè€ƒå‹åˆ¥ã€‚æ›è¨€ä¹‹ï¼Œå®ƒä¹Ÿæœƒæœ‰å¯¦è³ªå‹åˆ¥çš„é™åˆ¶ï¼Œä¾‹å¦‚ä¸æ”¯æ´ç¹¼æ‰¿ã€‚

**è§€å¯Ÿé‡é» 2**ï¼šä»¥ä½ç½®åƒæ•¸èªæ³•ä¾†å®šç¾©çš„è¨˜éŒ„ï¼Œç·¨è­¯å™¨æœƒè‡ªå‹•ç”¢ç”Ÿå°æ‡‰çš„å±¬æ€§ï¼›è€Œç·¨è­¯å™¨ç‚º `record struct` ç”¢ç”Ÿçš„å±¬æ€§ä¸¦éå”¯è®€ï¼Œè€Œæ˜¯å¯ä»¥éš¨æ™‚ä¿®æ”¹çš„ï¼Œå¦‚ç¬¬ 3ï½4 è¡Œçš„å±¬æ€§ X èˆ‡ Yã€‚é€™æ˜¯ `record struct` å’Œå–®ç´”å®£å‘Š `record` çš„ä¸€å€‹ä¸»è¦å·®ç•°ã€‚

å¦‚æœåŸºæ–¼æŸäº›åŸå› è€Œå¿…é ˆä½¿ç”¨ `record struct`ï¼ŒåŒæ™‚åˆå¸Œæœ›æ•´å€‹çµæ§‹æ˜¯å”¯è®€çš„ï¼Œæ­¤æ™‚æœ‰å…©ç¨®ä½œæ³•ï¼Œä¸€å€‹æ˜¯åœ¨å®£å‘Šæ™‚åŠ ä¸Š `readonly` é—œéµå­—ï¼š

~~~~~~~~csharp
public readonly record struct Point(int X, int Y);
~~~~~~~~

å¦ä¸€ç¨®ä½œæ³•æ˜¯æ”¹ç”¨ä¸€å°å¤§æ‹¬è™Ÿçš„å¯«æ³•ï¼Œä»¥ä¾¿æˆ‘å€‘å¯ä»¥æ›´ç´°ç·»åœ°å»è¨­è¨ˆæ¯å€‹å±¬æ€§çš„è¡Œç‚ºï¼š

~~~~~~~~csharp
public record struct Point
{
    public int X { get; init; }
    public int Y { get; init; }
}
~~~~~~~~

å¦‚æ­¤ä¸€ä¾†ï¼Œ`X` å’Œ `Y` ä¾¿æ˜¯ [init-only å±¬æ€§](https://github.com/huanlin/LearningNotes/blob/main/csharp9/_post.md#Init-only-Setter)ï¼Œäº¦å³åªèƒ½åœ¨ç‰©ä»¶åˆå§‹åŒ–çš„éç¨‹ä¸­è³¦å€¼ï¼Œéš¨å¾Œç„¡æ³•å†ä¿®æ”¹å…¶å€¼ã€‚

### `ToString` æ–¹æ³•å¯è¢«å¯†å°

**åŸºç¤çŸ¥è­˜**ï¼šç·¨è­¯å™¨æœƒå¹«æˆ‘å€‘è‡ªè¨‚çš„ `record` é¡å‹å®‰æ’è¨±å¤šç¨‹å¼ç¢¼ï¼Œå…¶ä¸­åŒ…æ‹¬[æ”¹å¯«çš„ `ToString` æ–¹æ³•](https://github.com/huanlin/LearningNotes/blob/main/csharp9/_post.md#tostring-%E6%96%B9%E6%B3%95)ã€‚

ç„¶è€Œï¼Œç•¶æˆ‘å€‘æœ‰å¤šå€‹è‡ªè¨‚çš„è¨˜éŒ„é¡å‹ï¼Œå½¼æ­¤ä¹‹é–“æœ‰å¥½å¹¾å±¤ç¹¼æ‰¿é—œä¿‚æ™‚ï¼Œç·¨è­¯å™¨æä¾›çš„é€™é …åŠŸèƒ½åå€’æœƒå‡ºå•é¡Œï¼šä½æ–¼ç¹¼æ‰¿éšå±¤é ‚ç«¯çš„è¨˜éŒ„å¦‚æœæƒ³è¦æŠŠ `ToString` çš„è¼¸å‡ºçµæœå›ºå®šä¸‹ä¾†ï¼Œä¸è®“å¾Œä»£äº‚æ”¹ï¼Œé€™åœ¨ C# 9 æ˜¯è¾¦ä¸åˆ°çš„ï¼Œå› ç‚ºç·¨è­¯å™¨ç¸½æ˜¯æœƒæ›¿å­ä»£è¨˜éŒ„æ”¹å¯« `ToString` æ–¹æ³•ã€‚

æ–¼æ˜¯æœ‰äººæƒ³åˆ°ï¼Œä½•ä¸åœ¨åŸºç¤å‹åˆ¥è£¡é¢åŠ ä¸Š `sealed` ä¿®é£¾è©ä¾†ç¦æ­¢å¾Œä»£ä¿®æ”¹å‘¢ï¼Ÿåƒé€™æ¨£ï¼š

~~~~~~~~csharp
abstract record Point(int X, int Y)
{
    public sealed override string ToString() // C# 9: Error!
    {
        return $"({X},{Y})";
    }
}
~~~~~~~~

åœ¨ C# 9ï¼Œç¬¬ 3 è¡Œç„¡æ³•é€šéç·¨è­¯ã€‚éŒ¯èª¤è¨Šæ¯æ˜¯ï¼š

> Error CS8773:	Feature 'sealed ToString in record' is not available in C# 9.0. 

åˆ°äº† C# 10ï¼Œä¸Šåˆ—ç¨‹å¼ç¢¼ä¾¿å¯ä»¥é€šéç·¨è­¯ã€‚å¦‚æ­¤ä¸€ä¾†ï¼Œä¾¿å¯é˜²æ­¢ä»–äººï¼ˆç‰¹åˆ¥æ˜¯ç·¨è­¯å™¨ï¼‰æ”¹å¯«çˆ¶ä»£è¨˜éŒ„çš„æ–¹æ³•ã€‚

> å¯¦ä½œæ­¤åŠŸèƒ½çš„ Thomas Levesque æ›¾åœ¨æŸå€‹è¨è«–ä¸²ä¸­èªªï¼šã€Œthis feature isn't really to prevent a user from overriding the method, but to prevent the compiler from doing so.ã€

## çµæ§‹çš„æ”¹é€²

C# 10 çš„çµæ§‹ï¼ˆstructï¼‰é¡å‹æœ‰å…©è™•æ”¹é€²ï¼šç„¡åƒæ•¸å»ºæ§‹å¼ã€å¯ä½¿ç”¨ `with` èªæ³•ä¾†é€²è¡Œåˆå§‹åŒ–ã€‚

ç¯„ä¾‹ï¼š

~~~~~~~~csharp
public struct Point
{
    public int X { get; set; }
    public int Y { get; set; }
    
    public Point() // C# 9 ç„¡æ³•ç·¨è­¯!
    {
        X = 5;
        Y = 5;
    }
}
~~~~~~~~

ç¬¬ 6 è¡Œçœ‹èµ·ä¾†æ²’ä»€éº¼ç‰¹åˆ¥ï¼Œåªæ˜¯ä¸å¸¶åƒæ•¸çš„å»ºæ§‹å¼ç½·äº†ï¼Œé€™åœ¨é¡åˆ¥å¾ˆå¸¸è¦‹ï¼Œä½† C# 9 çš„çµæ§‹ä¸å…è¨±é€™æ¨£å¯«ï¼Œåˆ° C# 10 æ‰å¯ä»¥ã€‚

æ¥è‘—çœ‹å¦ä¸€é …æ”¹é€²ï¼šå¯ä½¿ç”¨ `with` èªæ³•ä¾†é€²è¡Œåˆå§‹åŒ–ã€‚

~~~~~~~~csharp
var p1 = new Point { X = 0, Y = 0 };
var p2 = point1 with { X = 5 }; // C# 9 ä¸æ”¯æ´ï¼ŒC# 10 OK!
~~~~~~~~

## åŒ¿åå‹åˆ¥çš„éç ´å£å¼è®Šå½¢

C# 9 æ–°å¢äº† `with` é—œéµå­—ä¾†å°è¨˜éŒ„ï¼ˆrecordï¼‰åŸ·è¡Œéç ´å£å¼è®Šå½¢ï¼ˆnon-destructive mutationï¼‰ã€‚åˆ°äº† C# 10ï¼Œé€™å€‹èªæ³•ä¹Ÿèƒ½ç”¨æ–¼åŒ¿åå‹åˆ¥ï¼š

~~~~~~~~csharp
var obj1 = new { X = 1, Y = 2, Z = 3 };
var obj2 = obj1 with { Y = 10 };
Console.WriteLine (obj2); // { X = 1, Y = 10, Z = 3 }
~~~~~~~~

> æœ‰é—œè¨˜éŒ„çš„éç ´å£å¼è®Šå½¢èªæ³•ï¼Œå¯åƒé–± C# 9 ç­†è¨˜çš„ã€ˆ[è¨˜éŒ„ï¼šè¤‡è£½ç‰©ä»¶](https://github.com/huanlin/LearningNotes/blob/main/csharp9/_post.md#%E8%A4%87%E8%A3%BD%E7%89%A9%E4%BB%B6)ã€‰ä¸€ç¯€çš„èªªæ˜ã€‚

## å­—ä¸²æ’è£œçš„æ•ˆèƒ½æ”¹é€²

C# 10 (.NET 6) çš„å­—ä¸²æ’è£œï¼Œç„¡è«–åŸ·è¡Œé€Ÿåº¦é‚„æ˜¯è¨˜æ†¶é«”çš„ä½¿ç”¨æ•ˆç‡ï¼Œéƒ½æ¯” C# 9 (.NET 5) å¥½å¾ˆå¤šã€‚é‚£éº¼ï¼Œæ•ˆèƒ½ç©¶ç«Ÿæå‡å¤šå°‘å‘¢ï¼Ÿæˆ‘ç”¨ä¸€å€‹ç°¡å–®çš„å°ç¨‹å¼ä¾†æ¸¬è©¦ï¼Œçµæœç™¼ç¾ C# 10 çš„å­—ä¸²æ’è£œæ¯” C# 9 å¿«äº†å¤§ç´„ä¸€å€ï¼Œè€Œä¸”ä½¿ç”¨çš„è¨˜æ†¶é«”ä¹Ÿæ›´çœã€‚æ¸¬è©¦çš„éç¨‹èˆ‡ç›¸é—œèªªæ˜ï¼Œè«‹åƒè€ƒé€™å€‹ Youtube å½±ç‰‡ï¼š[C# 10 (.NET 6) å­—ä¸²æ’è£œçš„æ•ˆèƒ½æ”¹é€²](https://www.youtube.com/watch?v=rXZGEmBk79c)ã€‚

> ç¨‹å¼ç¢¼ï¼š[StringInterpolationPerformanceTest](https://github.com/huanlin/LearningNotes/tree/main/csharp10/examples/StringInterpolationPerformanceTest)ã€‚

å½±ç‰‡ä¸­ç”¨ä¾†è§€å¯ŸåŸ·è¡Œæ•ˆèƒ½çš„ Today æ–¹æ³•ï¼Œåªæ˜¯å–®ç´”ç”¨å­—ä¸²æ’è£œä¾†çµ„æˆã€Œä»Šå¤©æ˜¯æŸå¹´æŸæœˆæŸæ—¥ã€çš„å­—ä¸²ï¼š

~~~~~~~~csharp
public string Today()
{
    var d = DateTime.Now;
    return $"ä»Šå¤©æ˜¯ {d.Year} å¹´ {d.Month} æœˆ {d.Day} æ—¥";
}
~~~~~~~~

åœ¨ C# 9ï¼Œä¸Šåˆ—ç¨‹å¼ç¢¼æœƒè¢«ç·¨è­¯æˆé€™æ¨£ï¼š

~~~~~~~~csharp
// C# 9 è½‰è­¯çµæœï¼ˆä½¿ç”¨ string.Format æ–¹æ³•ï¼‰
public string Today()
{
	DateTime d = DateTime.Now;
	return string.Format("ä»Šå¤©æ˜¯ {0} å¹´ {1} æœˆ {2} æ—¥", d.Year, d.Month, d.Day);
}
~~~~~~~~

ä¹Ÿå°±æ˜¯èªªï¼ŒC# 9 ä½¿ç”¨äº† `string.Format()` ä¾†å¯¦ç¾å­—ä¸²æ’è£œï¼Œè€Œæ­¤ä½œæ³•å¾€å¾€éœ€è¦ä»˜å‡ºè¼ƒé«˜çš„æˆæœ¬ã€‚æ¯”å¦‚èªªï¼Œå®ƒå¿…é ˆé¡å¤–é…ç½®ä¸€å€‹é™£åˆ—ä¾†å­˜æ”¾å¼•æ•¸ã€å¯èƒ½éœ€è¦é¡å¤–è™•ç†å¯¦è³ªå‹åˆ¥çš„è£ç®±ï¼ˆboxingï¼‰ã€ç„¡æ³•æ¸›å°‘éå¿…è¦çš„å­—ä¸²å»ºæ§‹â€¦â€¦ç­‰ç­‰ã€‚

> ä»€éº¼æ™‚å€™æœƒç¢°åˆ°ã€Œéå¿…è¦çš„å­—ä¸²å»ºæ§‹ã€ï¼Ÿä¸€å€‹å¸¸è¦‹çš„ä¾‹å­æ˜¯è¼¸å‡º Log è¨Šæ¯çš„å ´åˆã€‚ç¨å¾Œä»‹ç´¹å­—ä¸²è™•ç†å™¨çš„æ™‚å€™æœƒæœ‰é€²ä¸€æ­¥çš„èªªæ˜ã€‚

åˆ°äº† C# 10ï¼Œå‰‡æ¡å–ä¸åŒçš„ä½œæ³•ï¼Œå…¶è½‰è­¯çµæœæœƒåƒé€™æ¨£ï¼š

~~~~~~~~csharp
// c# 10 è½‰è­¯çµæœ
public string Today()
{
	DateTime d = DateTime.Now;
	var defaultInterpolatedStringHandler = new DefaultInterpolatedStringHandler(12, 3);
	defaultInterpolatedStringHandler.AppendLiteral("ä»Šå¤©æ˜¯ ");
	defaultInterpolatedStringHandler.AppendFormatted(d.Year);
	defaultInterpolatedStringHandler.AppendLiteral(" å¹´ ");
	defaultInterpolatedStringHandler.AppendFormatted(d.Month);
	defaultInterpolatedStringHandler.AppendLiteral(" æœˆ ");
	defaultInterpolatedStringHandler.AppendFormatted(d.Day);
	defaultInterpolatedStringHandler.AppendLiteral(" æ—¥");
	return defaultInterpolatedStringHandler.ToStringAndClear();
}
~~~~~~~~

ç¨‹å¼ç¢¼è®Šå¤šäº†ï¼ŒåŸ·è¡Œé€Ÿåº¦å»æ›´å¿«ï¼Œæ¶ˆè€—çš„è¨˜æ†¶é«”ä¹Ÿæ›´å°‘ã€‚å°±å¦‚å‰é¢å½±ç‰‡æ‰€å±•ç¤ºçš„æ¸¬è©¦çµæœï¼Œæ•´é«”æ•ˆèƒ½æ¯” C# 9 çš„å­—ä¸²æ’è£œæå‡äº†ä¸€å€å·¦å³ã€‚åœ¨é »ç¹ä½¿ç”¨å­—ä¸²æ’è£œçš„å ´åˆï¼ˆä¾‹å¦‚è¿´åœˆï¼‰ï¼Œæ•ˆèƒ½å·®è·æœƒæ›´æ˜é¡¯ã€‚é€™æ¨£çš„å¯«æ³•æœ‰é» `StringBuilder` çš„å‘³é“ï¼Œå°å§ï¼Ÿåªæ˜¯é€™æ¬¡å®Œå…¨ç”±ç·¨è­¯å™¨è‡ªå‹•ç”Ÿæˆï¼Œä¸ç”¨æˆ‘å€‘è‡ªå·±æ‰‹å·¥ä¸€è¡Œä¸€è¡Œå»åˆ»ï¼Œè€Œä¸”å¯¦éš›è² è²¬çµ„åˆå­—ä¸²çš„æ˜¯ .NET 6 æ–°åŠ å…¥çš„çµæ§‹ï¼š`DefaultInterpolatedStringHandler`ï¼Œä¹Ÿå°±æ˜¯é è¨­çš„å­—ä¸²æ’è£œè™•ç†å™¨ã€‚

### å­—ä¸²æ’è£œè™•ç†å™¨

ä¸Šä¸€ç¯€æœ«å°¾æåˆ°äº† C# 10 çš„å­—ä¸²æ’è£œèªæ³•èƒŒå¾Œè² è²¬çµ„åˆå­—ä¸²çš„æ˜¯ä¸€å€‹å«åš `DefaultInterpolatedStringHandler` çš„çµæ§‹ã€‚æ¯ç•¶ç·¨è­¯å™¨ç¢°åˆ°å­—ä¸²æ’è£œèªæ³•æ™‚ï¼Œä¾¿æœƒä½¿ç”¨é€™å€‹é è¨­çš„å­—ä¸²æ’è£œè™•ç†å™¨ä¾†å»ºæ§‹å­—ä¸²ã€‚é€™ä¾¿æ˜¯ C# 10 çš„å­—ä¸²æ’è£œæ•ˆèƒ½å„ªæ–¼ C# 9 çš„ä¸»è¦åŸå› ã€‚

åœ¨æŸäº›ç‰¹æ®Šå ´åˆï¼Œæˆ‘å€‘ç”šè‡³å¯ä»¥è‡ªè¡Œè¨­è¨ˆç‰¹å®šç”¨é€”çš„å­—ä¸²æ’è£œè™•ç†å™¨ï¼Œä»¥æ¸›å°‘ä¸€äº›éå¿…è¦çš„å­—ä¸²é€£æ¥æ“ä½œï¼Œé€²ä¸€æ­¥æå‡æ‡‰ç”¨ç¨‹å¼çš„åŸ·è¡Œæ•ˆèƒ½ã€‚ä¸€å€‹å¸¸è¦‹çš„ä¾‹å­æ˜¯è¼¸å‡º log è¨Šæ¯çš„å ´åˆã€‚æ¯”å¦‚èªªï¼Œæ‡‰ç”¨ç¨‹å¼åœ¨è¨±å¤šåœ°æ–¹å‘¼å«äº† logging API ä¾†è¨˜éŒ„ç¨‹å¼çš„åŸ·è¡Œéç¨‹èˆ‡éŒ¯èª¤è¨Šæ¯ï¼Œä¸¦ä¸”åœ¨ä¸éœ€è¦è¨˜éŒ„çš„æ™‚å€™ï¼Œè—‰ç”±ä¿®æ”¹çµ„æ…‹æª”ä¾†é—œé–‰è¨˜éŒ„åŠŸèƒ½ã€‚ç„¶è€Œï¼Œç¨‹å¼è£¡é¢æœ‰è¨±å¤šåœ°æ–¹åœ¨å‘¼å« logging API çš„æ™‚å€™ä½¿ç”¨äº†å­—ä¸²æ’è£œèªæ³•ä¾†çµ„åˆå­—ä¸²ï¼Œå³ä¾¿æŠŠè¨˜éŒ„åŠŸèƒ½é—œé–‰äº†ï¼Œé‚£äº›å‚³éçµ¦ logging API çš„å­—ä¸²é‚„æ˜¯æœƒåœ¨ç¨‹å¼åŸ·è¡Œçš„æ™‚å€™ç¶“ç”± `DefaultInterpolatedStringHandler` ä¾†é€²è¡Œå­—ä¸²çš„çµ„åˆã€‚è«‹çœ‹ä»¥ä¸‹ç¯„ä¾‹ï¼š

~~~~~~~~csharp
var date = DateTime.Now;
logger.Enabled = true;  // å•Ÿç”¨è¨˜éŒ„åŠŸèƒ½
logger.Log($"ä»Šå¤©æ˜¯ {date.Month} æœˆ {date.Day} æ—¥");

logger.Enabled = false;  // é—œé–‰è¨˜éŒ„åŠŸèƒ½
logger.Log($"ä»Šå¤©æ˜¯ {date.Month} æœˆ {date.Day} æ—¥");
~~~~~~~~

ç¬¬ 3 è¡Œå‘¼å« Log æ–¹æ³•æ™‚ï¼Œè¨˜éŒ„å™¨çš„åŠŸèƒ½æ˜¯å•Ÿç”¨çš„ï¼Œé€™è£¡æ²’æœ‰å•é¡Œã€‚æ¥ä¸‹ä¾†ï¼Œç¬¬ 5 è¡ŒæŠŠè¨˜éŒ„åŠŸèƒ½é—œé–‰ï¼Œæ•…ç¬¬ 6 è¡Œå‘¼å« `Log` æ–¹æ³•æ™‚ï¼Œå„˜ç®¡è©²æ–¹æ³•åœ¨å…§éƒ¨æœƒç›´æ¥è¿”å›ã€ä¸è¼¸å‡ºä»»ä½• logï¼Œä½†å‘¼å« `Log` æ–¹æ³•æ™‚çš„å­—ä¸²æ’è£œèªæ³•å»é‚„æ˜¯æœƒé€é `DefaultInterpolatedStringHandler` ä¾†å®Œæˆå­—ä¸²çš„çµ„åˆï¼Œè€Œé€™äº›çµ„åˆå­—ä¸²çš„æ“ä½œç­‰æ–¼æ˜¯ç™½åšå·¥äº†ã€‚

å‰›æ‰èˆ‰çš„ä¾‹å­ï¼Œå¦‚æœä½ æ˜¯é‚£å€‹ logging API çš„è¨­è¨ˆè€…ï¼Œä¾¿å¯ä»¥ç‰¹åˆ¥ç‚ºå®ƒæ’°å¯«ä¸€å€‹å­—ä¸²æ’è£œè™•ç†å™¨ï¼Œä¾†é¿å…ç„¡è¬‚çš„æ•ˆèƒ½æè€—ã€‚ä»¥ä¸‹ç¯„ä¾‹ä»¿è‡ªå¾®è»Ÿæ–‡ä»¶ï¼š[Improved Interpolated Strings](https://docs.microsoft.com/zh-tw/dotnet/csharp/language-reference/proposals/csharp-10.0/improved-interpolated-strings#the-handler-pattern)ã€‚

~~~~~~~~csharp
using System.Runtime.CompilerServices;
......
[InterpolatedStringHandler]
public ref struct MyLoggerInterpolatedStringHandler
{
    private DefaultInterpolatedStringHandler _handler;

    public MyLoggerInterpolatedStringHandler(
        int literalLength, int formattedCount,
        MyLogger logger, out bool handlerIsValid)
    {
        if (!logger.Enabled)
        {
            _innerHandler = default;
            handlerIsValid = false;
            return;
        }

        _handler = new DefaultInterpolatedStringHandler(literalLength, formattedCount);
        handlerIsValid = true;
    }

    public void AppendLiteral(string msg)
    {
        _handler.AppendLiteral(msg);
    }

    public void AppendFormatted<T>(T msg)
    {
        _handler.AppendFormatted(msg);
    }

    public string ToStringAndClear()
    {
        return _handler.ToStringAndClear();
    }
}
~~~~~~~~

å­—ä¸²æ’è£œè™•ç†å™¨çš„è¨­è¨ˆè¦é»å¦‚ä¸‹ï¼š

- å®£å‘Šå‹åˆ¥çš„æ™‚å€™å¿…é ˆå¥—ç”¨ `InterpolatedStringHandler` ç‰¹å¾µé …ï¼ˆç¬¬ 3 è¡Œï¼‰ã€‚
- å®£å‘Šå‹åˆ¥çš„æ™‚å€™åŠ ä¸Š `ref struct`ï¼Œè¡¨ç¤ºé€™å€‹å­—ä¸²æ’è£œè™•ç†å™¨æ˜¯å€‹çµæ§‹ï¼Œè€Œä¸”å¿…é ˆæ˜¯é…ç½®æ–¼å †ç–Šä¸­çš„çµæ§‹ï¼ˆå³ä¸å¯é…ç½®æ–¼å †ç©ï¼›åƒè¦‹ã€ˆ[C# 7ï¼šåªèƒ½æ”¾åœ¨å †ç–Šçš„çµæ§‹ï¼šref struct](https://github.com/huanlin/LearningNotes/blob/main/csharp7/_post.md#%E5%8F%AA%E8%83%BD%E6%94%BE%E5%9C%A8%E5%A0%86%E7%96%8A%E7%9A%84%E7%B5%90%E6%A7%8Bref-struct)ã€‰ï¼‰ã€‚
- å»ºæ§‹å¼è‡³å°‘è¦æœ‰å…©å€‹ `int` åƒæ•¸ï¼š`literalLength` å’Œ `formattedCount`ï¼ˆç¬¬ 8ï½10 è¡Œï¼‰ã€‚å‰è€…ä»£è¡¨å¸¸æ•¸å­—å…ƒçš„å­—æ•¸ï¼Œå¾Œè€…å‰‡ç‚ºéœ€è¦æ’è£œï¼ˆæ ¼å¼åŒ–ï¼‰çš„æ•¸é‡ã€‚æ¯”å¦‚èªªï¼Œ`$"Hi, {name}"` é€™å€‹å­—ä¸²æ¨£æ¿çš„ `literalLength` æ˜¯ 4ï¼Œè€Œ `formattedCount` æ˜¯ 1ã€‚
- å»ºæ§‹å¼é‚„å¯ä»¥è¦–éœ€è¦åŠ å…¥å…©å€‹é¡å¤–åƒæ•¸ï¼šä¸€å€‹æ˜¯ä¾†æºç‰©ä»¶ï¼ˆç¬¬ 10 è¡Œçš„ `logger` åƒæ•¸ï¼‰ï¼Œå¦ä¸€å€‹æ˜¯å¸ƒæ—å‹åˆ¥çš„è¼¸å‡ºåƒæ•¸ï¼Œä»£è¡¨å­—ä¸²è™•ç†å™¨æ˜¯å¦å¯ç”¨ï¼ˆï¼ˆç¬¬ 10 è¡Œçš„ `handlerIsValid` åƒæ•¸ï¼‰ã€‚
- å¿…é ˆæä¾› `AppendLiteral` å’Œ `AppendFormatted` æ–¹æ³•ã€‚åœ¨å»ºç«‹å­—ä¸²çš„éç¨‹ä¸­æœƒå‘¼å«é€™å…©å€‹æ–¹æ³•ã€‚
- å¿…é ˆæä¾› `ToStringAndClear` æ–¹æ³•ï¼Œä»¥å‚³å›æœ€çµ‚çµ„åˆå®Œæˆçš„å­—ä¸²ã€‚

ç›¸è¼ƒæ–¼ `DefaultInterpolatedStringHandler`ï¼Œé€™è£¡ç¤ºç¯„çš„å­—ä¸²æ’è£œè™•ç†å™¨åªæœ‰ä¸€å€‹æ¯”è¼ƒç‰¹åˆ¥çš„åœ°æ–¹ï¼Œå³å»ºæ§‹å¼æœƒæ ¹æ“šä¾†æºç‰©ä»¶ `logger` çš„ `Enabled` å±¬æ€§ï¼ˆæ˜¯å¦å•Ÿç”¨è¨˜éŒ„ï¼‰ä¾†æ±ºå®šæ˜¯å¦éœ€è¦é€²è¡Œå­—ä¸²æ’è£œï¼š

- å¦‚æœä¸éœ€è¦è¨˜éŒ„ï¼Œå‰‡ä¸å»ºç«‹å­—ä¸²æ’è£œè™•ç†å™¨ï¼Œä¸¦å°‡è¼¸å‡ºåƒæ•¸ `handlerIsValid` è¨­ç‚º `false`ã€‚ï¼ˆç¬¬ 12ï½17 è¡Œï¼‰
- å¦‚æœéœ€è¦è¨˜éŒ„ï¼ˆç¬¬ 19ï½20 è¡Œï¼‰ï¼Œå‰‡å»ºç«‹ä¸€å€‹ `DefaultInterpolatedStringHandler` ç‰©ä»¶ï¼Œè€Œä¸”å¾€å¾Œçš„å­—ä¸²çµ„åˆæ“ä½œéƒ½æ˜¯è½‰äº¤çµ¦å®ƒè™•ç†ï¼›é€™äº›æ“ä½œåŒ…æ‹¬ï¼š`AppendLiteral`ã€`AppendFormatted`ã€å’Œ `ToStringAndClear` æ–¹æ³•ã€‚

æ¥è‘—ä¾†çœ‹è¨˜éŒ„å™¨é¡åˆ¥çš„ç¨‹å¼ç¢¼ï¼š

~~~~~~~~csharp
public class MyLogger
{
    public bool Enabled { get; set; }

    public void Log(
        [InterpolatedStringHandlerArgument("")]
        ref MyLoggerInterpolatedStringHandler handler)
    {
        if (Enabled)
        {
            string msg = handler.ToStringAndClear();
            Console.WriteLine(msg);
        }
    }
}
~~~~~~~~

ä½ å¯ä»¥çœ‹åˆ°ï¼Œ`Log` æ–¹æ³•çš„ `handler` åƒæ•¸çš„å‹åˆ¥ä¸¦éå–®ç´”çš„ `string`ï¼Œè€Œæ˜¯æˆ‘å€‘è¨­è¨ˆçš„çš„å­—ä¸²è™•ç†å™¨ `MyLoggerInterpolatedStringHandler`ã€‚

æ­¤å¤–ï¼Œ`handler` åƒæ•¸å‰é¢å¥—ç”¨çš„ç‰¹å¾µé … `[InterpolatedStringHandlerArgument("")]`ï¼Œæ˜¯ç”¨ä¾†æŒ‡å®šæ¬²å‚³éçµ¦ `MyLoggerInterpolatedStringHandler` å»ºæ§‹å¼çš„å¼•æ•¸ã€‚ç”±æ–¼æ­¤ç¯„ä¾‹ä¸¦æ²’æœ‰éœ€è¦æŠŠç•¶å‰å¼•æ•¸åˆ—ç•¶ä¸­çš„æŸå€‹å¼•æ•¸å‚³éçµ¦å­—ä¸²æ’è£œè™•ç†å™¨çš„å»ºæ§‹å¼ï¼Œæ•…å‚³å…¥ç©ºå­—ä¸²ï¼Œè¡¨ç¤ºè¦å‚³å…¥ç•¶å‰å‘¼å«æ­¤æ–¹æ³•çš„ç‰©ä»¶ï¼ˆäº¦å³ `this`ï¼‰ã€‚å¦‚æœä½ è¦ºå¾—å‰›å‰›çš„è§£é‡‹ä¸å¥½ç†è§£ï¼Œä¸å¦¨å°ç…§ä¸€ä¸‹æˆ‘å€‘çš„å­—ä¸²æ’è£œè™•ç†å™¨çš„å»ºæ§‹å¼ï¼š

~~~~~~~~csharp
[InterpolatedStringHandler]
public ref struct MyLoggerInterpolatedStringHandler
{
    public MyLoggerInterpolatedStringHandler(
        int literalLength, int formattedCount,
        MyLogger logger, out bool handlerIsValid)
    { ...... }
}
~~~~~~~~

é€™è£¡è¦é—œæ³¨çš„æ˜¯å»ºæ§‹å¼çš„ç¬¬ä¸‰å€‹åƒæ•¸ï¼š`logger`ã€‚ç•¶æˆ‘å€‘æ’°å¯«é¡ä¼¼åº•ä¸‹çš„ç¨‹å¼ç¢¼ï¼š

~~~~~~~~csharp
var name = "Michael";
var aLogger = new MyLogger();
aLogger.Log($"Hello, {name}");
~~~~~~~~

ç·¨è­¯å™¨çœ‹åˆ°å‚³å…¥ `Log` æ–¹æ³•çš„åƒæ•¸æ˜¯å­—ä¸²æ’è£œçš„èªæ³•ï¼Œå°±æœƒçŸ¥é“è¦å…ˆå»ºç«‹ä¸€å€‹ `MyLoggerInterpolatedStringHandler` å‹åˆ¥çš„å­—ä¸²æ’è£œè™•ç†å™¨ï¼Œä¸¦ç”±è©²ç‰©ä»¶ä¾†è² è²¬çµ„åˆå­—ä¸²ã€‚å»ºç«‹è©²ç‰©ä»¶æ™‚ï¼Œä¾¿æœƒå°‡ç•¶æ™‚çš„ `aLogger` ç‰©ä»¶å‚³å…¥è‡³ `MyLoggerInterpolatedStringHandler` çš„ç¬¬ä¸‰å€‹åƒæ•¸ã€‚é€™ä¾¿æ˜¯ç¨æ—©èªªçš„ï¼Œå¥—ç”¨ `[InterpolatedStringHandlerArgument("")]` ç‰¹å¾µé …æ™‚å‚³å…¥ç©ºå­—ä¸²çš„ä½œç”¨ã€‚é‚£éº¼ï¼Œä»€éº¼æƒ…æ³æœƒéœ€è¦å‚³å…¥æŸå€‹å¼•æ•¸çš„åç¨±å‘¢ï¼Ÿå…¶ä¸­ä¸€å€‹å¸¸è¦‹çš„å ´åˆæ˜¯æ“´å……æ–¹æ³•ï¼Œä¾‹å¦‚ï¼š

~~~~~~~~csharp
public static class MyLoggerExtension
{
    public static void Log(
        this MyLogger logger, 
        [InterpolatedStringHandlerArgument("logger")] 
        ref MyLoggerInterpolatedStringHandler handler)
    {
        ......
    }
}
~~~~~~~~

ç¬¬ 5 è¡Œçš„æ„æ€æ˜¯ï¼šè«‹æŠŠé€™æ¬¡å‘¼å«çš„åƒæ•¸åˆ—ä¸­åç‚º `logger` çš„ç‰©ä»¶å‚³å…¥è‡³ `MyLoggerInterpolatedStringHandler` å»ºæ§‹å¼çš„ç¬¬ä¸‰å€‹åƒæ•¸ã€‚

OKï¼Œæˆ‘å€‘çš„å­—ä¸²æ’è£œè™•ç†å™¨å·²ç¶“å¯«å¥½äº†ï¼Œç¾åœ¨å›é ­çœ‹æœ¬ç¯€é–‹é ­çš„ç¨‹å¼ç¢¼ï¼š

~~~~~~~~csharp
var date = DateTime.Now;
logger.Enabled = true;  // å•Ÿç”¨è¨˜éŒ„åŠŸèƒ½
logger.Log($"ä»Šå¤©æ˜¯ {date.Month} æœˆ {date.Day} æ—¥");

logger.Enabled = false;  // é—œé–‰è¨˜éŒ„åŠŸèƒ½
logger.Log($"ä»Šå¤©æ˜¯ {date.Month} æœˆ {date.Day} æ—¥");
~~~~~~~~

æˆ‘å€‘ä¾¿å¯ä»¥é”æˆä»¥ä¸‹ç›®çš„ï¼š

- ç¬¬ 2ï½3 è¡Œï¼šåœ¨è¨˜éŒ„åŠŸèƒ½é–‹å•Ÿçš„æƒ…æ³ä¸‹ï¼Œå‘¼å« `Log` æ–¹æ³•ä¸¦å‚³å…¥éœ€è¦æ’è£œçš„å­—ä¸²æ™‚ï¼Œæœƒå»ºç«‹ `MyLoggerInterpolatedStringHandler` ç‰©ä»¶ï¼Œä¸¦ç”±å®ƒä¾†è² è²¬å®Œæˆå­—ä¸²çµ„åˆçš„å·¥ä½œã€‚
- ç¬¬ 5ï½6 è¡Œï¼šåœ¨è¨˜éŒ„åŠŸèƒ½é—œé–‰çš„æƒ…æ³ä¸‹ï¼Œå‘¼å« `Log` æ–¹æ³•ä¸¦å‚³å…¥éœ€è¦æ’è£œçš„å­—ä¸²æ™‚ï¼Œä¸æœƒå»ºç«‹ `MyLoggerInterpolatedStringHandler` ç‰©ä»¶ï¼Œæ‰€ä»¥ä¹Ÿä¸æœƒç”¢ç”Ÿä»»ä½•å­—ä¸²çµ„åˆæ‰€éœ€çš„æ•ˆèƒ½æè€—â€”â€”æ›´å¿«ã€æ›´çœè¨˜æ†¶é«”ã€‚

è‡³æ–¼ä¸Šè¿°å…©ç¨®æƒ…å½¢çš„æ•ˆèƒ½æè€—å·®ç•°ï¼Œæˆ‘å¦å¤–å¯«äº†ä¸€å€‹å°ç¨‹å¼ä¾†è§€å¯Ÿï¼Œä¸¦ä¸”éŒ„è£½æˆå½±ç‰‡ã€‚è«‹é»æ­¤é€£çµè§€çœ‹ï¼šTODO

## `CallerArgumentExpression` ç‰¹å¾µé …

`[CallerArgumentExpression]` ç‰¹å¾µé …å¯ç”¨ä¾†æ•æ‰å‡½å¼ä¸­çš„æŸå€‹å‚³å…¥åƒæ•¸çš„è¡¨é”å¼ï¼Œä¸¦å°‡å…¶è¡¨é”å¼ä¿å­˜æ–¼å¦ä¸€å€‹å­—ä¸²åƒæ•¸ã€‚ç¯„ä¾‹ï¼š

~~~~~~~~csharp
Show(Math.Sqrt(9)); // å–å¹³æ–¹æ ¹

void Show(double num,
          [CallerArgumentExpression("num")] string expr = null)
    => Console.WriteLine(expr + $" = {num}");
~~~~~~~~

åŸ·è¡Œçµæœï¼š

~~~~~~~~
Math.Sqrt(9) = 3
~~~~~~~~

å¾é€™å€‹ä¾‹å­å¯ä»¥çœ‹å¾—å‡ºä¾†ï¼Œå‘¼å«ç«¯å‚³å…¥ `num` åƒæ•¸çš„æ™‚å€™æ˜¯æ€éº¼å¯«çš„ï¼Œç•¶æ™‚çš„å¯«æ³•å°±æœƒè¢«æ•æ‰ä¸¦ä¿å­˜æ–¼å­—ä¸²åƒæ•¸ `expr`ã€‚ç”±æ–¼ä¸éœ€è¦å‘¼å«ç«¯å‚³å…¥ `expr` åƒæ•¸ï¼Œæ•…æ­¤åƒæ•¸åœ¨å®£å‘Šçš„æ™‚å€™å¿…é ˆçµ¦ä¸€å€‹é è¨­å€¼ï¼ˆé€šå¸¸æ˜¯ `null`ï¼‰ã€‚æ­¤å¤–ï¼Œ`[CallerArgumentExpression]` å¯ä»¥åœ¨åŒä¸€å€‹æ–¹æ³•ç•¶ä¸­ä½¿ç”¨å¤šæ¬¡ï¼Œäº¦å³å¯æ•æ‰å¤šå€‹åƒæ•¸ã€‚

é€™é …åŠŸèƒ½å°æ–¼æ¸¬è©¦ã€é©—è­‰ã€æˆ–è¼¸å‡ºè¨˜éŒ„ï¼ˆlogï¼‰è¨Šæ¯çš„å ´åˆç‰¹åˆ¥æœ‰ç”¨ã€‚ä¾‹å¦‚ï¼š

~~~~~~~~csharp
IsTrue(1 + 1 == 3);

void IsTrue(bool value,
[CallerArgumentExpression("value")] string expr = null)
{
    if (!value)
        throw new ArgumentException($"{expr} ä¸æ˜¯çœŸçš„!");
}
~~~~~~~~

åŸ·è¡Œçµæœï¼š

~~~~~~~~
System.ArgumentException: 1 + 1 == 3 ä¸æ˜¯çœŸçš„!
~~~~~~~~

> è©¦è©¦çœ‹ï¼šhttps://dotnetfiddle.net/etlTWD

é€™è£¡ä¸å¦¨é †ä¾¿è¤‡ç¿’ä¸€ä¸‹å…¶ä»– Caller* ç‰¹å¾µé …ï¼ˆå¾ C# 5 ä¾¿å·²æä¾›ï¼‰ï¼š

~~~~~~~~csharp
Log("ç™¼ç”ŸéŒ¯èª¤");

void Log(
    string msg,
    [CallerMemberName] string caller = null, 
    [CallerFilePath] string filePath = null, 
    [CallerLineNumber] int lineNum = 0) 
{
    Console.WriteLine(
        $"{msg}, å‘¼å«ç«¯: {caller}, æª”æ¡ˆ: {filePath}, è¡Œè™Ÿ: {lineNum}");
}
~~~~~~~~

åŸ·è¡Œçµæœï¼š

~~~~~~~~
ç™¼ç”ŸéŒ¯èª¤, å‘¼å«ç«¯: Main, æª”æ¡ˆ: Program.cs, è¡Œè™Ÿ: 12
~~~~~~~~

> è©¦è©¦çœ‹ï¼šhttps://dotnetfiddle.net/wDYoVB

ä»¥ä¸ŠæåŠçš„ Caller* ç‰¹å¾µé …çš†éš¸å±¬æ–¼ `System.Runtime.CompilerServices` å‘½åç©ºé–“ã€‚

## `AsyncMethodBuilder` ç‰¹å¾µé …å¯å¥—ç”¨è‡³æ–¹æ³• 

æ‰“å¾ C# 7 é–‹å§‹ï¼Œ`[AsyncMethodBuilder]` ç‰¹å¾µé …ä¾¿å¯ä»¥å¥—ç”¨è‡³é¡åˆ¥ã€‚åˆ°äº† C# 10ï¼Œå‰‡å¯ä»¥å¥—ç”¨è‡³æ–¹æ³•ã€‚æ­¤ç‰¹å¾µé …å¯ç”¨ä¾†å‘Šè¨´ç·¨è­¯å™¨ï¼šã€Œåœ¨è™•ç†éåŒæ­¥æ–¹æ³•çš„æ™‚å€™ï¼Œè«‹æ”¹ç”¨æˆ‘æä¾›çš„é¡åˆ¥ä¾†å»ºæ§‹èƒŒå¾Œçš„éåŒæ­¥ç‹€æ…‹æ©Ÿã€‚ã€

> å°æ–¼ä¸€èˆ¬çš„æ‡‰ç”¨ç¨‹å¼è€Œè¨€ï¼Œæ‡‰è©²ä¸å¤ªæœƒç”¨åˆ°é€™é …åŠŸèƒ½ã€‚

ç¯„ä¾‹ï¼š

~~~~~~~~csharp
[AsyncMethodBuilder(typeof(MyAsyncMethodBuilder))]
public void MyMethod()
{
}

public class MyAsyncMethodBuilder
{
    public static MyAsyncMethodBuilder Create()
        => new MyAsyncMethodBuilder();
    
    ...ï¼ˆå…¶é¤˜çœç•¥ï¼‰
}   
~~~~~~~~

æ­¤ç¯„ä¾‹çœç•¥äº† `MyAsyncMethodBuilder` æ–¹æ³•çš„å¯¦ä½œã€‚æ ¹æ“šå®˜æ–¹æ–‡ä»¶ï¼Œæ­¤é¡åˆ¥å¿…é ˆæä¾›ä¸‹åˆ—æˆå“¡ï¼š

- éœæ…‹æ–¹æ³• `Create`ï¼Œç”¨ä¾†å»ºç«‹ `MyAsyncMethodBuilder` çš„åŸ·è¡Œå€‹é«”ã€‚
- å±¬æ€§ `Task`ï¼Œç”¨ä¾†æä¾›éåŒæ­¥å·¥ä½œçš„å›å‚³å‹åˆ¥ã€‚
- `void SetException(Exception)` æ–¹æ³•ï¼Œç”¨ä¾†è¨­å®šéåŒæ­¥å·¥ä½œå¤±æ•—æ™‚çš„ä¾‹å¤–ã€‚
- `void SetResult()` æˆ– `void SetResult(T result)` æ–¹æ³•ï¼Œä»¥æ¨™è¨˜å·¥ä½œå®Œæˆï¼Œæˆ–è€…åŒæ™‚è¨­å®šå·¥ä½œçµæœã€‚
- `void Start<TStateMachine>` æ–¹æ³•ã€‚
- `void AwaitOnCompleted<TAwaiter, TStateMachine>` æ–¹æ³•ã€‚
- `void AwaitUnsafeOnCompleted<TAwaiter, TStateMachine>` æ–¹æ³•ã€‚

ä»¥ä¸Šåƒ…ç‚ºé‡é»æ‘˜éŒ„ï¼Œå¦‚æ¬²ç²å–æ›´å®Œæ•´çš„èªªæ˜ï¼Œå¯åƒè€ƒå®˜æ–¹æ–‡ä»¶ã€ˆ[AsyncMethodBuilder override](https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/proposals/csharp-10.0/async-method-builders)ã€‰ï¼Œä»¥åŠåŸå§‹ç¢¼ [AsyncMethodBuilder.cs](https://referencesource.microsoft.com/#mscorlib/system/runtime/compilerservices/AsyncMethodBuilder.cs)ã€‚

## å…¶ä»–æ”¹é€²

é™¤äº†å‰é¢ä»‹ç´¹çš„æ–°åŠŸèƒ½ï¼ŒC# 10 é‚„å°æ—¢æœ‰çš„ `#line` æŒ‡ç¤ºè©åšäº†é€²ä¸€æ­¥å¼·åŒ–ã€‚ä½†é€™é …åŠŸèƒ½å°å¤šæ•¸äººè€Œè¨€å¹«åŠ©ä¸å¤§ï¼Œå¯èƒ½åªæœ‰åœ¨æ’°å¯«ç¨‹å¼ç¢¼ç”¢ç”Ÿå™¨çš„æ™‚å€™æ‰æœƒç”¨åˆ°ï¼Œæ‰€ä»¥é€™è£¡ç•¥éä¸æã€‚

å¦‚æœä½ æƒ³è¦å­¸ç¿’ `#line` æŒ‡ç¤ºè©çš„ç”¨æ³•ï¼Œå¯åƒé–±å¾®è»Ÿæ–‡ä»¶ï¼šã€ˆ[Enhanced #line directives](https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/proposals/csharp-10.0/enhanced-line-directives)ã€‰ã€‚

---

![å‰µç”¨ CC æˆæ¬Šæ¢æ¬¾](https://i.creativecommons.org/l/by-nc-nd/3.0/tw/88x31.png)

â¬†ï¸[å›é ‚ç«¯](https://github.com/huanlin/LearningNotes/blob/main/csharp10/_post.md#c-10)
â†©ï¸[å›é¦–é ](https://github.com/huanlin/LearningNotes#readme)
