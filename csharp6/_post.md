# C# 6

**ğŸ‘‰ä»»æ„é–€**ï¼š[C# 6](https://github.com/huanlin/LearningNotes/blob/main/csharp6/_post.md#c-6) | [C# 7](https://github.com/huanlin/LearningNotes/blob/main/csharp7/_post.md#c-7) | [C# 8](https://github.com/huanlin/LearningNotes/blob/main/csharp8/_post.md#c-8)  | [C# 9](https://github.com/huanlin/LearningNotes/blob/main/csharp9/_post.md#c-9) | [C# 10](https://github.com/huanlin/LearningNotes/blob/main/csharp10/_post.md#c-10) | [é¦–é ](https://github.com/huanlin/LearningNotes#readme)

æœ¬ç« è¦ä»‹ç´¹çš„æ˜¯ C# 6 æ–°å¢çš„èªæ³•ï¼ŒåŒ…æ‹¬ï¼š

 - [`nameof` é‹ç®—å­](#nameof-é‹ç®—å­)
 - [å­—ä¸²æ’å€¼](#å­—ä¸²æ’å€¼)
 - [å”¯è®€è‡ªå‹•å¯¦ä½œå±¬æ€§](#å”¯è®€è‡ªå‹•å¯¦ä½œå±¬æ€§)
 - [è‡ªå‹•å±¬æ€§çš„åˆå§‹è¨­å®šå¼](#è‡ªå‹•å±¬æ€§çš„åˆå§‹è¨­å®šå¼)
 - [ä»¥è¡¨ç¤ºå¼ç‚ºæœ¬é«”çš„æˆå“¡](#ä»¥è¡¨ç¤ºå¼ç‚ºæœ¬é«”çš„æˆå“¡)
 - [ç´¢å¼•åˆå§‹è¨­å®šå¼](#ç´¢å¼•åˆå§‹è¨­å®šå¼)
 - [`using static` é™³è¿°å¼](#using-static-é™³è¿°å¼)
 - [ä¾‹å¤–ç¯©é¸æ¢ä»¶](#ä¾‹å¤–ç¯©é¸æ¢ä»¶)
 - [ `catch` å’Œ `finally` å€å¡Šä¸­çš„ `await`](#catch-å’Œ-finally-å€å¡Šä¸­çš„-await)

---

 ## `nameof` é‹ç®—å­

C# 6 æ–°å¢çš„ `nameof` é—œéµå­—å¯ç”¨ä¾†å–å¾—æŸç¬¦è™Ÿçš„åç¨±ï¼Œä¾‹å¦‚å‹åˆ¥ã€è®Šæ•¸ã€ç‰©ä»¶æˆå“¡ç­‰ç­‰ã€‚è«‹çœ‹åº•ä¸‹é€™å€‹ç°¡å–®ç¯„ä¾‹ï¼š

~~~~~~~~csharp
string firstName = "Joey";
string varName = nameof(firstName);  // ç·¨è­¯çµæœï¼švarName = "firstName"
~~~~~~~~

ç¨‹å¼ç¢¼å³é‚Šçš„è¨»è§£å·²ç¶“é€éœ²ï¼Œ`nameof` æ˜¯ä½œç”¨æ–¼ç·¨è­¯æ™‚æœŸï¼Œè€ŒéåŸ·è¡Œæ™‚æœŸã€‚

é‚£éº¼ï¼Œå®ƒå¯ä»¥ç”¨åœ¨å“ªè£¡å‘¢ï¼Ÿ

æ¯”å¦‚èªªï¼Œç‚ºäº†é˜²éŒ¯ï¼Œæˆ‘å€‘ç¶“å¸¸åœ¨å‡½å¼ä¸­é å…ˆæª¢æŸ¥åƒæ•¸å€¼æ˜¯å¦åˆæ³•ï¼Œä¸¦å°‡ä¸åˆæ³•çš„åƒæ•¸é€éæ‹‹å‡ºä¾‹å¤–ï¼ˆexceptionï¼‰çš„æ–¹å¼é€šçŸ¥å‘¼å«ç«¯ï¼ˆæˆ–è€…å¯«å…¥ log æª”æ¡ˆä»¥ä¾›å°‡ä¾†è¨ºæ–·å•é¡Œï¼‰ã€‚åƒé€™æ¨£ï¼š

~~~~~~~~csharp
void LoadProduct(string productId)
{
    if (productId == null)
    {
        throw new ArgumentNullException("productId"));
    }
    ....
}
~~~~~~~~

å¦‚æ­¤ä¸€ä¾†ï¼Œç•¶ç¨‹å¼å‡ºéŒ¯æ™‚ï¼Œç”¨æˆ¶ç«¯å°±èƒ½è¼•æ˜“çŸ¥é“æ˜¯å“ªå€‹åƒæ•¸ä¸å°ã€‚å•é¡Œæ˜¯ï¼Œç¨‹å¼ä¸­çš„åƒæ•¸åç¨±æ˜¯å¯«æ­»çš„å­—ä¸²å€¼ï¼ˆ`"productId"`ï¼‰ï¼Œå°‡ä¾†è¬ä¸€è¦ä¿®æ”¹åƒæ•¸åç¨±ï¼Œç¨ä¸æ³¨æ„å°±æœƒæ¼æ”¹é€™äº›å­—ä¸²ã€‚æ–¼æ˜¯ï¼Œå³ä½¿ç…è²»å‘¨ç« ï¼Œä»æœ‰äººé¸æ“‡åœ¨åŸ·è¡Œæ™‚æœŸå‹•æ…‹å–å¾—åƒæ•¸åç¨±ï¼Œåªç‚ºäº†é¿å…åœ¨ç¨‹å¼ä¸­å¯«ä¸€å †å›ºå®šçš„å­—ä¸²ã€‚å…¶å¯¦ï¼Œåƒæ•¸åç¨±åœ¨ç·¨è­¯æ™‚æœŸå°±å·²ç¶“æ±ºå®šäº†ï¼Œä½•ä¸ç”±ç·¨è­¯å™¨ä»£å‹ï¼Œæ—¢çœäº‹åˆä¸çŠ§ç‰²åŸ·è¡Œæ•ˆç‡ï¼Ÿ

ç¾åœ¨ï¼ŒC# 6 æä¾›äº† `nameof` è¡¨ç¤ºå¼ï¼Œæ­£å¥½å¯ä»¥è§£æ±ºé€™å€‹å•é¡Œã€‚æ–¼æ˜¯å‰›æ‰çš„ç¯„ä¾‹å¯ä»¥æ”¹å¯«æˆé€™æ¨£ï¼š

~~~~~~~~csharp
void LoadProduct(string productId)
{
    if (productId == null)
    {
        throw new ArgumentNullException(nameof(productId));
    }
    ....
}
~~~~~~~~

å…¶ä¸­çš„ `nameof(productId)` è¡¨ç¤ºå¼åœ¨ç¶“éç·¨è­¯ä¹‹å¾Œï¼Œçµæœå°±ç­‰æ–¼æ‰‹å¯«çš„å›ºå®šå­—ä¸² `"productId"`ã€‚

## å­—ä¸²æ’å€¼

åœ¨ C# 6 ä¹‹å‰ï¼Œéœ€è¦æ ¼å¼åŒ–å­—ä¸²çš„æ™‚å€™ï¼Œå¤§å¤šå‘¼å« .NET Framework æä¾›çš„å­—ä¸²æ ¼å¼åŒ–æ–¹æ³• `String.Format(...)`ã€‚åœ¨ C# 6 é–‹å§‹æä¾›äº†å¦ä¸€ç¨®æ›´æ–¹ä¾¿çš„æ ¼å¼åŒ–å­—ä¸²èªæ³•ï¼Œåæ›°ã€Œå­—ä¸²æ’å€¼ã€ï¼ˆstring interpolationï¼‰ã€‚

å­—ä¸²æ’å€¼çš„åŸºæœ¬èªæ³•ï¼Œæ˜¯åœ¨é›™å¼•è™ŸåŒ…ä½çš„å­—ä¸²å‰é¢åŠ ä¸Šä¸€å€‹ `'$'` å­—å…ƒï¼Œè€Œåœ¨å­—ä¸²å…§å®¹çš„éƒ¨åˆ†ä½¿ç”¨ä¸€å°å¤§æ‹¬å¼§ `{}` ä¾†åŒ…ä½ä¸€å€‹è®Šæ•¸åç¨±ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š

{line-numbers=off, lang=text}
    $"{è®Šæ•¸åç¨±:æ ¼å¼è¦ç¯„}"

å…¶ä¸­çš„ã€Œæ ¼å¼è¦ç¯„ã€å°±è·Ÿ `String.Format()` æ–¹æ³•æ‰€ä½¿ç”¨çš„æ ¼å¼è¦ç¯„å­—å…ƒä¸€æ¨£ã€‚ä¸€å€‹æ ¼å¼å­—ä¸²è£¡é¢å¯ä»¥æœ‰å¤šå°å¤§æ‹¬å¼§ï¼Œç”¨ä¾†å¸¶å…¥ä¸åŒçš„è®Šæ•¸å€¼ï¼Œè€Œæ²’æœ‰è¢«å¤§æ‹¬å¼§åŒ…ä½çš„éƒ¨åˆ†å‰‡ç¶­æŒä¸è®Šã€‚

åƒè€ƒåº•ä¸‹çš„ç¯„ä¾‹ï¼š

~~~~~~~~csharp
string firstName = "Michael";
string lastName = "Tsai";
int salary = 22000;

string msg1 = String.Format("{0} {1} çš„æœˆè–ªæ˜¯ {2:C0}", firstName, lastName, salary);
string msg2 = $"{firstName} {lastName} çš„æœˆè–ªæ˜¯ {salary :C0}";
Console.WriteLine(msg1);
Console.WriteLine(msg2);
~~~~~~~~

çµæœå…©æ¬¡è¼¸å‡ºçš„å­—ä¸²å€¼éƒ½ç›¸åŒï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

~~~~~~~~
Michael Tsai çš„æœˆè–ªæ˜¯ 22,000
Michael Tsai çš„æœˆè–ªæ˜¯ 22,000
~~~~~~~~

è·Ÿæ—¢æœ‰çš„ `String.Format()` æ–¹æ³•æ¯”è¼ƒï¼Œæˆ‘è¦ºå¾—å­—ä¸²æ’å€¼çš„å¯«æ³•æ›´å®¹æ˜“è§£è®€ï¼Œæ›´å®¹æ˜“æƒ³åƒæœ€çµ‚æ ¼å¼åŒ–çš„çµæœã€‚åŸå› åœ¨æ–¼ï¼Œè§£è®€ `String.Format()` æ™‚ï¼Œæˆ‘å€‘å¿…é ˆæŠŠå³é‚Šçš„åƒæ•¸ä¾åºå¸¶å…¥å·¦é‚Šçš„æ ¼å¼å­—ä¸²ï¼›å¦‚æœåƒæ•¸å¾ˆå¤šï¼Œæœ‰æ™‚é‚„æœƒå°ä¸ä¸Šï¼Œå°è‡´é †åºéŒ¯ç½®ã€‚æ–°çš„å­—ä¸²æ’å€¼èªæ³•å‰‡æ˜¯ç›´æ¥åœ¨æ ¼å¼å­—ä¸²è£¡é¢å¡«å…¥è®Šæ•¸åç¨±ï¼Œä¸åƒ…ç›´è§€ï¼Œè€Œä¸”ä¸æœƒæœ‰å¼„éŒ¯é †åºçš„å•é¡Œã€‚

å­—ä¸²æ’å€¼è·Ÿ `nameof` è¡¨ç¤ºå¼ä¸€æ¨£éƒ½æ˜¯èªæ³•ç³–ï¼Œæ˜¯ç·¨è­¯æ™‚æœŸçš„é­”æ³•ã€‚æ˜ç™½åœ°èªªï¼Œç·¨è­¯å™¨æœƒæŠŠå­—ä¸²æ’å€¼çš„èªæ³•ç·¨è­¯æˆ `String.Format()` æ–¹æ³•å‘¼å«ã€‚åº•ä¸‹æ˜¯æ›´å¤šå­—ä¸²æ’å€¼çš„ç¯„ä¾‹ï¼Œå³é‚Šè¨»è§£å‰‡æ˜¯ç·¨è­¯å¾Œçš„çµæœã€‚

~~~~~~~~csharp
$"å§“å = {myName}"    // String.Format("å§“å = {0}", myName)
$"å°æ™‚ = {DateTime.Now:hh}"  // String.Format("å°æ™‚ = {0:hh}", DateTime.Now)
$"{{æ¸¬è©¦å¤§æ‹¬å¼§}}"      // String.Format("{{æ¸¬è©¦å¤§æ‹¬å¼§}}")
$"{{ç§’ = {DateTime.Now :ss}}}" // String.Format("{{ç§’ = {0:ss}}}", DateTime.Now)
~~~~~~~~

éœ€æ³¨æ„çš„æ˜¯ï¼Œå…©å€‹é€£çºŒçš„å¤§æ‹¬å¼§ä»£è¡¨æ¬²è¼¸å‡ºä¸€å€‹å¤§æ‹¬å¼§å­—å…ƒã€‚æ•…ç¬¬ä¸‰å€‹ä¾‹å­çš„åŸ·è¡Œçµæœç‚º "{æ¸¬è©¦å¤§æ‹¬å¼§}"ã€‚

## `Null` æ¢ä»¶é‹ç®—å­

ä¿éšªèµ·è¦‹ï¼Œåœ¨éœ€è¦å­˜å–æŸç‰©ä»¶çš„å±¬æ€§ä¹‹å‰ï¼Œæˆ‘å€‘é€šå¸¸æœƒå…ˆæª¢æŸ¥è©²ç‰©ä»¶æ˜¯å¦ç‚º `null`ï¼Œä»¥å…ç¨‹å¼åŸ·è¡Œæ™‚æ‹‹å‡ºä¾‹å¤–ï¼ˆ`NullReferenceException`ï¼‰ã€‚ä¸€èˆ¬å¸¸è¦‹çš„å¯«æ³•å¦‚ä¸‹ï¼š

~~~~~~~~csharp
static void NullPropagationDemo(string s)
{
    if (s != null && s.Length == 4) // åªæœ‰ç•¶ s ä¸ç‚ºç©ºæ™‚æ‰å­˜å–å®ƒçš„ Length å±¬æ€§ã€‚
    {
        // Do something.
    }
}
~~~~~~~~

C# 6 æ–°å¢äº† `null` æ¢ä»¶é‹ç®—å­èªæ³•ï¼Œè®“ä½ ç”¨æ›´ç°¡çŸ­çš„èªæ³•é”åˆ°åŒæ¨£æ•ˆæœï¼šå…ˆåˆ¤æ–·ç‰©ä»¶æ˜¯å¦ç‚º `null`ï¼Œä¸æ˜¯ `null` æ‰æœƒå­˜å–å…¶æˆå“¡ã€‚å®ƒçš„å¯«æ³•æ˜¯åœ¨è®Šæ•¸å¾Œé¢è·Ÿè‘—ä¸€å€‹å•è™Ÿï¼Œç„¶å¾Œæ˜¯å­˜å–æˆå“¡åç¨±çš„è¡¨ç¤ºå¼ã€‚åƒè€ƒä»¥ä¸‹ç¯„ä¾‹ï¼š

~~~~~~~~csharp
static void NullPropagationDemo(string s)
{
    if (s?.Length == 4) // åªæœ‰ç•¶ s ä¸ç‚ºç©ºæ™‚æ‰å­˜å–å®ƒçš„ Length å±¬æ€§ã€‚
    {
        // Do something.
    }
}
~~~~~~~~

æ›´å¤šç¯„ä¾‹ï¼š

~~~~~~~~csharp
int? length = empList?.Length; // è‹¥ empList æ˜¯ nullï¼Œå‰‡ length ä¹Ÿæ˜¯ nullã€‚
Employee emp = empList?[0];    // è‹¥ empList æ˜¯ nullï¼Œå‰‡ obj ä¹Ÿæ˜¯ nullã€‚
int length = empList?.Length ?? 0;  // è‹¥ empList æ˜¯ nullï¼Œå‰‡ length æ˜¯ 0ã€‚
string name = empList?[0].FullName; // è‹¥ empList æ˜¯ nullï¼Œå‰‡ name æ˜¯ nullã€‚
~~~~~~~~

## å”¯è®€è‡ªå‹•å¯¦ä½œå±¬æ€§

è«‹çœ‹ä»¥ä¸‹ç¨‹å¼ç‰‡æ®µï¼š

~~~~~~~~csharp
// C# 3ï¼šè‡ªå‹•å¯¦ä½œå±¬æ€§ï¼ˆå…å¯«ç§æœ‰æ¬„ä½ï¼‰ã€‚
public class Employee
{
    public string ID { get; private set; } // å¤–ç•Œå¯è®€ï¼Œä½†ä¸å¯æ”¹è®Šæ­¤å±¬æ€§å€¼ã€‚

    public Employee(string id) // å»ºæ§‹å­
    {
        ID = id; // è¨­å®šè‡ªå‹•å±¬æ€§ ID çš„åˆå§‹å€¼ã€‚
    }
}
~~~~~~~~

å…¶ä¸­ `ID` æ˜¯å€‹è‡ªå‹•å¯¦ä½œå±¬æ€§ï¼ˆæˆ–ç°¡ç¨±ã€Œè‡ªå‹•å±¬æ€§ã€ï¼‰ï¼Œå®ƒå¯è®“å¤–ç•Œè®€å–ï¼Œä½†æ˜¯åªæœ‰é¡åˆ¥æœ¬èº«æ‰èƒ½ä¿®æ”¹å…¶å€¼ã€‚æ‰€è¬‚çš„é¡åˆ¥æœ¬èº«ï¼Œç•¶ç„¶åŒ…å«é¡åˆ¥çš„å»ºæ§‹å­å’Œæ–¹æ³•ã€‚å¯æ˜¯ï¼Œå¦‚æœæˆ‘å€‘å¸Œæœ›é€™å€‹å”¯è®€å±¬æ€§åªå…è¨±åœ¨å»ºæ§‹å­ä¸­è¨­å®šä¸€æ¬¡åˆå§‹å€¼ï¼Œä»¥å¾Œå°±å†ä¹Ÿä¸èƒ½ä¿®æ”¹äº†â€”â€”å³ä½¿åœ¨é¡åˆ¥çš„å…¶ä»–æ–¹æ³•ä¸­ä¹Ÿä¸èƒ½ä¿®æ”¹ï¼Œé€™ç¨®æƒ…æ³è¦æ€éº¼å¯«å‘¢ï¼Ÿ C# 5 æ²’è¾¦æ³•åšåˆ°â€”â€”é™¤éä½¿ç”¨å”¯è®€çš„ç§æœ‰æ¬„ä½ï¼Œä½†ç¨‹å¼ç¢¼å¯«èµ·ä¾†æ¯”è¼ƒå›‰å—¦ã€‚

C# 6 åœ¨é€™æ–¹é¢åšäº†æ”¹é€²ï¼Œå¢åŠ äº†ã€Œ**å”¯è®€è‡ªå‹•å¯¦ä½œå±¬æ€§**ã€ï¼ˆread-only automatically implemented propertiesï¼‰èªæ³•ï¼Œæˆ–ç°¡ç¨±ã€Œ**å”¯è®€è‡ªå‹•å±¬æ€§**ã€ã€‚è«‹çœ‹ä»¥ä¸‹ç¯„ä¾‹ï¼š

~~~~~~~~csharp
// C# 6ï¼šå”¯è®€è‡ªå‹•å±¬æ€§ã€‚
public class Employee
{
    public string ID { get; } // æ²’æœ‰ setterï¼Œé€™æ˜¯å€‹å”¯è®€è‡ªå‹•å±¬æ€§ã€‚

    public Employee(string id)
    {
        ID = id; // è¨­å®šå”¯è®€è‡ªå‹•å±¬æ€§çš„åˆå§‹å€¼ã€‚
    }

    private void ChangeID(int id)
    {
        ID = id;  // ç·¨è­¯å¤±æ•—ï¼šID æ˜¯å”¯è®€å±¬æ€§!
    }
}
~~~~~~~~

å¦‚æ‚¨æ‰€è¦‹ï¼Œæ­¤è™•æœ‰å…©å€‹é‡é»ï¼š

* å±¬æ€§ ID åªæœ‰ getterï¼Œæ²’æœ‰ setter äº†ã€‚å®ƒæ˜¯å€‹å”¯è®€è‡ªå‹•å±¬æ€§ã€‚
* ç”±æ–¼ ID æ˜¯å”¯è®€å±¬æ€§ï¼Œå› æ­¤å³ä½¿æ˜¯é¡åˆ¥è‡ªå·±ä¹Ÿç„¡æ³•ä¿®æ”¹ ID çš„å€¼â€”â€”å»ºæ§‹å­é™¤å¤–ã€‚

### æ˜ç¢ºå¯¦ä½œä»‹é¢çš„å”¯è®€å±¬æ€§

ç¾åœ¨ï¼Œä½ å·²ç¶“çŸ¥é“å”¯è®€è‡ªå‹•å±¬æ€§çš„èªæ³•äº†ï¼Œä¸”è®“æˆ‘å€‘ä¾†çœ‹ä¸€å€‹æœ‰é»å¾®å¦™ã€å¯èƒ½ä»¤ä½ é©šè¨çš„å•é¡Œã€‚è«‹çœ‹åº•ä¸‹é€™æ®µç¨‹å¼ç¢¼ï¼š

~~~~~~~~csharp
interface IEmployee
{
    int Salary { get; }   // å”¯è®€å±¬æ€§ã€‚
}

class Employee : IEmployee
{
    public int Salary { get; } // éš±å«å¯¦ä½œ IEmployee.Salary å±¬æ€§ã€‚

    public Employee()
    {
        Salary = 70000; // åœ¨å»ºæ§‹å‡½å¼ä¸­åˆå§‹åŒ–å”¯è®€å±¬æ€§ã€‚
    }
}
~~~~~~~~

èªªæ˜ï¼š

* ä»‹é¢ `IEmployee` åªå®šç¾©äº†ä¸€å€‹æˆå“¡ï¼š`Salary`ï¼Œå®ƒæ˜¯å€‹å”¯è®€å±¬æ€§ã€‚
* é¡åˆ¥ `Employee` **éš±å«å¯¦ä½œ**äº† `IEmployee.Salary` å±¬æ€§ã€‚ç”±æ–¼å®ƒæ˜¯å”¯è®€è‡ªå‹•å±¬æ€§ï¼Œæ•…åœ¨å»ºæ§‹å‡½å¼ä¸­è¨­å®šå…¶åˆå§‹å€¼ã€‚

é‚£éº¼ï¼Œå¦‚æœæˆ‘å€‘æƒ³è¦æ”¹æˆ**æ˜ç¢ºå¯¦ä½œ**ï¼ˆexplicitly implementï¼‰ä»‹é¢çš„å¯«æ³•ï¼Œç›´è¦ºä¸Šå¯èƒ½æœƒé€™æ¨£å¯«ï¼š

~~~~~~~~csharp
class Employee : IEmployee
{
    int IEmployee.Salary { get; } // æ˜ç¢ºå¯¦ä½œ IEmployee.Salary å±¬æ€§ã€‚

    public Employee()
    {
        Salary = 70000; // ç·¨è­¯å¤±æ•—: æ­¤è™•ç„¡æ³•ä½¿ç”¨ Salary!
    }
}
~~~~~~~~

å€’æ•¸ç¬¬ä¸‰è¡Œç„¡æ³•é€šéç·¨è­¯ï¼ŒéŒ¯èª¤è¨Šæ¯æ˜¯ï¼š

> The name 'Salary' does not exist in the current context.
> ï¼ˆåœ¨ç›®å‰çš„å€å¡Šè£¡é¢ä¸å­˜åœ¨ 'Salary' é€™å€‹æ±è¥¿ã€‚ï¼‰

é€™æ˜¯å› ç‚º C# èªæ³•è¦å®šï¼Œæ¡ç”¨ã€Œæ˜ç¢ºå¯¦ä½œä»‹é¢ã€çš„æ™‚å€™ï¼Œä¸èƒ½åœ¨é¡åˆ¥è£¡é¢ç›´æ¥ä»¥åç¨±ä¾†å­˜å–ä»‹é¢çš„æˆå“¡ã€‚

é‚£éº¼ï¼ŒæŠŠç™¼ç”ŸéŒ¯èª¤çš„é‚£è¡Œç¨‹å¼ç¢¼æ”¹æˆé€™æ¨£å‘¢ï¼š

~~~~~~~~csharp
(this as IEmployee).Salary = 70000;
~~~~~~~~

é€™ä¹Ÿè¡Œä¸é€šï¼Œç·¨è­¯å™¨æœƒå‘Šè¨´ä½ ï¼š

> Property or indexer 'IEmployee.Salary' cannot be assigned to -- it is read only.

å› ç‚º `Salary` æœ¬ä¾†å°±æ˜¯å®šç¾©æˆå”¯è®€å±¬æ€§ï¼Œä¸å¯ä¿®æ”¹ã€‚

å¯æ˜¯ï¼Œå›é ­å†çœ‹ä¸€ä¸‹å‰é¢çš„ç¯„ä¾‹ï¼Œç•¶æˆ‘å€‘æ¡ç”¨éš±å«å¯¦ä½œä»‹é¢çš„å¯«æ³•æ™‚ï¼Œ`Salary` ä¹Ÿæ˜¯å®šç¾©æˆå”¯è®€å±¬æ€§ï¼Œå»å¯ä»¥åœ¨å»ºæ§‹å‡½å¼ä¸­è¨­å®šåˆå§‹å€¼ã€‚é¡¯ç„¶ï¼Œã€Œåœ¨å»ºæ§‹å‡½å¼ä¸­å¯ä»¥è¨­å®šå”¯è®€å±¬æ€§ã€é€™é …èªæ³•è¦å‰‡ï¼Œä¸€æ—¦ç¢°åˆ°æ˜ç¢ºå¯¦ä½œä»‹é¢çš„å ´åˆå°±è¡Œä¸é€šäº†ã€‚

è‹¥ä¸€å®šè¦ä½¿ç”¨æ˜ç¢ºå¯¦ä½œä»‹é¢çš„å¯«æ³•ï¼Œæˆ‘å€‘å¯ä»¥ç¹å€‹å½ï¼Œç”¨å”¯è®€çš„ç§æœ‰æ¬„ä½ä¾†ä¿å­˜å±¬æ€§å€¼ï¼Œä¾¿å¯è§£æ±ºã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š

~~~~~~~~csharp
class Employee : IEmployee
{
    private readonly int _salary;   // å”¯è®€çš„ç§æœ‰æ¬„ä½ã€‚

    int IEmployee.Salary    // æ˜ç¢ºå¯¦ä½œ IEmployee.Salary å±¬æ€§ã€‚
    {
        get { return _salary; }
    }

    public Employee()
    {
        _salary = 70000;
    }
}
~~~~~~~~

## è‡ªå‹•å±¬æ€§çš„åˆå§‹è¨­å®šå¼

åœ¨ C# 6 ä¹‹å‰ï¼Œè‡ªå‹•å±¬æ€§çš„åˆå§‹å€¼åªèƒ½é€éå»ºæ§‹å­ä¾†è¨­å®šï¼Œè€Œç„¡æ³•åœ¨å®£å‘Šå±¬æ€§çš„æ™‚å€™å°±è¨­å®šåˆå§‹å€¼ã€‚C# 6 å°æ­¤åšäº†æ”¹é€²ï¼Œæä¾›äº†ã€Œè‡ªå‹•å±¬æ€§åˆå§‹è¨­å®šå¼ã€ï¼ˆauto-property initializersï¼‰èªæ³•ï¼Œè®“æˆ‘å€‘èƒ½å¤ åœ¨å®£å‘Šå±¬æ€§çš„æ™‚å€™å°±ä¸€ä½µè¨­å®šåˆå§‹å€¼ã€‚å¦‚ä»¥ä¸‹ç¯„ä¾‹æ‰€ç¤ºï¼š

~~~~~~~~csharp
public class Employee
{
    public string ID { get; private set; } = "A001";
    public string Name { get; set; } = "Michael";
    public int Age { get; } = 20;
}
~~~~~~~~

æ­¤èªæ³•çš„ä¸»è¦ç‰¹è‰²ï¼Œæ˜¯åœ¨å®šç¾©è‡ªå‹•å±¬æ€§çš„æ™‚å€™ç”¨ `=` é‹ç®—å­ä¾†åŠ ä¸Šè³¦å€¼æ•˜è¿°ï¼Œä»¥è¨­å®šè©²å±¬æ€§çš„åˆå§‹å€¼ã€‚éœ€æ³¨æ„çš„æ˜¯ï¼Œæ­¤è³¦å€¼èªæ³•åªèƒ½ç”¨æ–¼è‡ªå‹•å¯¦ä½œå±¬æ€§ï¼›è‹¥ç”¨åœ¨éè‡ªå‹•å±¬æ€§ï¼Œç·¨è­¯æ™‚æœƒå ±éŒ¯ã€‚æ‰€ä»¥åº•ä¸‹çš„ç¨‹å¼ç¢¼ç„¡æ³•é€šéç·¨è­¯ï¼š

~~~~~~~~csharp
public class Employee
{
    private string _name;

    public string Name
    {
        get { return _name; }
        set { _name = value; }
    } = "å¦å£ºæ²–"  // ç·¨è­¯éŒ¯èª¤! åªæœ‰è‡ªå‹•å±¬æ€§æ‰å…è¨±åˆå§‹è¨­å®šå¼ã€‚
}
~~~~~~~~

å¦å¤–ï¼Œè‡ªå‹•å±¬æ€§çš„åˆå§‹è¨­å®šå¼ç„¡æ³•é€é `this` ä¾†å­˜å–è©²é¡åˆ¥çš„å…¶ä»–æˆå“¡ã€‚ä¹Ÿå°±æ˜¯èªªï¼Œå¦‚æœæƒ³è¦åœ¨è‡ªå‹•å±¬æ€§çš„åˆå§‹è¨­å®šå¼ä¸­å‘¼å«è©²é¡åˆ¥çš„æ–¹æ³•ï¼Œå‰‡è©²æ–¹æ³•å¿…é ˆæ˜¯éœæ…‹æ–¹æ³•ã€‚è«‹çœ‹ä»¥ä¸‹ç¯„ä¾‹èˆ‡è¨»è§£ä¸­çš„èªªæ˜ï¼š

~~~~~~~~csharp
public class Employee
{
    public int Age { get; } = this.GetAge(); // ç·¨è­¯å¤±æ•—ï¼ä¸å¯å‘¼å« instance æˆå“¡ã€‚
    public int Salary { get; } = GetSalary();  // OK! å¯ä»¥å‘¼å«éœæ…‹æ–¹æ³•ã€‚

    int GetAge() { return 20; }
    static int GetSalary() { return 20000; } // æ³¨æ„ï¼šé€™æ˜¯å€‹éœæ…‹æ–¹æ³•ã€‚
}
~~~~~~~~

åœ¨é€²å…¥ä¸‹ä¸€å€‹è­°é¡Œä¹‹å‰ï¼Œæˆ‘æƒ³å†è£œå……ä¸€ä¸‹**å”¯è®€è‡ªå‹•å±¬æ€§**æ‰€æä¾›çš„ã€Œä¸å¯è®Šæ€§ã€ï¼ˆimmutabilityï¼‰åœ¨å¯«ç¨‹å¼çš„æ™‚å€™æœ‰ä»€éº¼å¥½è™•ã€‚è«‹çœ‹åº•ä¸‹çš„ç¯„ä¾‹ï¼š

~~~~~~~~csharp
public class Employee
{
    public List<string> Addresses { get; } // å”¯è®€è‡ªå‹•å±¬æ€§
    }

    public Employee() // åœ¨å»ºæ§‹å­ä¸­åˆå§‹åŒ–å”¯è®€è‡ªå‹•å±¬æ€§
    {
        Addresses = new List<string>();
    }

    public void DoSomethingStupid()
    {
        Addresses = null; // ç·¨è­¯å¤±æ•—ï¼šä¸å…è¨±ä¿®æ”¹ã€‚
    }
}
~~~~~~~~

å±¬æ€§ `Addresses` æ˜¯å€‹å”¯è®€è‡ªå‹•å±¬æ€§ï¼Œä¸€æ—¦åˆå§‹åŒ–å®Œæˆï¼Œå°±ä¸èƒ½åœ¨å…¶ä»–åœ°æ–¹ä¿®æ”¹ã€‚æ–¼æ˜¯ä¹ï¼Œå¤–ç•Œå¯ä»¥å–å¾— `Addresses` ä¸²åˆ—ï¼Œä¸¦ä¸”å‘¼å«å®ƒçš„ `Add` æˆ– `Remove` æ–¹æ³•ä¾†å¢åŠ æˆ–åˆªé™¤å…ƒç´ ï¼Œä½†æ˜¯ç„¡æ³•å°‡é€™å€‹ `Addresses` å±¬æ€§è¨­å®šæˆ `null` æˆ–æŒ‡å‘å…¶ä»–ä¸²åˆ—ã€‚åƒè€ƒä»¥ä¸‹ç¯„ä¾‹ï¼š

~~~~~~~~csharp
public static void Main()
{
    var emp = new Employee();
    emp.Addresses.Add("å˜‰ç¾©å¸‚å¤§é¦¬è·¯ 123 è™Ÿ"); // OK!

    emp.Addresses = new List<string>(); // ç·¨è­¯å¤±æ•—ï¼šä¸å…è¨±ä¿®æ”¹ã€‚
}
~~~~~~~~

> ç¯„ä¾‹åŸå§‹ç¢¼ï¼šhttps://dotnetfiddle.net/9TINL9

## ä»¥è¡¨ç¤ºå¼ç‚ºæœ¬é«”çš„æˆå“¡

C# 6 æ–°å¢äº†ã€Œä»¥è¡¨ç¤ºå¼ç‚ºæœ¬é«”çš„æˆå“¡ã€èªæ³•ï¼Œè‹±æ–‡æ˜¯ **expression-bodied members**ã€‚æ„æ€æ˜¯ï¼šä»¥è¡¨ç¤ºå¼ä¾†ä½œç‚ºæˆå“¡æ–¹æ³•çš„æœ¬é«”ã€‚å—¯â€¦â€¦æˆ‘å€‘é‚„æ˜¯ç›´æ¥çœ‹ç¨‹å¼ç¢¼æ¯”è¼ƒæ¸…æ¥šå§ã€‚

C# 6 ä¹‹å‰ï¼š

~~~~~~~~csharp
class BeforeCSharp6
{
    private DateTime startTime = DateTime.Now;

    public int ElapsedSeconds
    {
        get
        {
            return (DateTime.Now - startTime).Seconds;
        }
    }
}
~~~~~~~~

æ­¤ç¯„ä¾‹çš„å”¯è®€å±¬æ€§ `ElapsedSeconds` çš„å€¼æ˜¯å‹•æ…‹è¨ˆç®—å‡ºä¾†çš„ï¼Œä»£è¡¨å¾ `startTime` é–‹å§‹ä¹‹å¾Œåˆ°ç›®å‰ç‚ºæ­¢ç¶“éäº†å¹¾ç§’é˜ã€‚

C# 6 ä¹‹å¾Œï¼Œå¯ä»¥é€™éº¼å¯«ï¼š

~~~~~~~~csharp
class NewInCsharp6
{
    private DateTime startTime = DateTime.Now;

    public int ElapsedSeconds => (DateTime.Now - startTime).Seconds;
}
~~~~~~~~

é€™è£¡ä½¿ç”¨äº† C# 6 æ–°å¢çš„ expression-bodied members èªæ³•ã€‚å¦‚æ‚¨æ‰€è¦‹ï¼Œç¨‹å¼ç¢¼è®Šå¾—æ›´ç°¡çŸ­äº†ã€‚åŸæœ¬çš„å”¯è®€å±¬æ€§ `ElapsedSeconds` çš„ `get` å€å¡Šæ‹¿æ‰äº†ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯å±¬æ€§åç¨±å¾Œé¢è·Ÿè‘—ä¸€å€‹ä»¥ `=>` ç¬¦è™Ÿé–‹å§‹çš„ lambda è¡¨ç¤ºå¼â€”â€”éª¨å­è£¡ï¼Œç·¨è­¯å™¨æœƒæŠŠå®ƒç·¨è­¯æˆä¸€å€‹ `get` æ–¹æ³•ï¼Œå°±è·Ÿå…ˆå‰çš„ `BeforeCSharp6` é¡åˆ¥è£¡é¢çš„å¯«æ³•é¡ä¼¼ã€‚

> å„˜ç®¡ä½¿ç”¨äº† `=>` ç¬¦è™Ÿï¼Œexpression-bodied members èªæ³•ä¸¦é lambda è¡¨ç¤ºå¼ï¼Œè€Œä¸”è·ŸåŒ¿åå§”æ´¾ä¹Ÿæ²’å•¥é—œä¿‚ï¼›å®ƒåªæ˜¯å–®ç´”å‘Šè¨´ç·¨è­¯å™¨ï¼šè«‹å»ºç«‹ä¸€å€‹å”¯è®€å±¬æ€§ï¼Œè€Œä¸”å®ƒçš„å›å‚³å€¼æœƒæ˜¯æ¥åœ¨ `=>` å¾Œé¢çš„è¡¨ç¤ºå¼çš„é‹ç®—çµæœã€‚å®ƒå°±åªæ˜¯èªæ³•ç³–è€Œå·²ã€‚

è¦æ³¨æ„çš„æ˜¯ï¼Œé€™å€‹è¡¨ç¤ºå¼åªèƒ½æœ‰ä¸€è¡Œæ•˜è¿°ï¼Œè€Œä¸èƒ½åŒ…å«å¤šè¡Œç¨‹å¼ç¢¼çš„å€å¡Šã€‚å› æ­¤ï¼Œä½ ä¸èƒ½é€™éº¼å¯«ï¼š

~~~~~~~~csharp
public int ElapsedSeconds =>
{
    return (DateTime.Now - startTime).Seconds; // ç·¨è­¯å¤±æ•—ï¼
}
~~~~~~~~

æ­¤å¤–ï¼Œã€Œä»¥è¡¨ç¤ºå¼ç‚ºæœ¬é«”çš„æˆå“¡ã€å¯ä»¥æ˜¯å±¬æ€§ã€ç´¢å¼•å­ï¼ˆindexerï¼‰æˆ–æ–¹æ³•ï¼Œè€Œä¸”æœ‰æ²’æœ‰å›å‚³å€¼éƒ½å¯ä»¥ã€‚åº•ä¸‹æ˜¯æ›´å¤šç¯„ä¾‹ï¼š

~~~~~~~~csharp
public class Demo
{
    public string FullName =>
            this.FirstName + " " + this.LastName;
    public Color GetColor(int r, int g, int b) =>
            Color.FromArgb(r, g, b);
    public void Log(string msg) => Console.WriteLine(msg);
    public static string HowCold(int temperature) =>
            temperature > 17 ? "ä¸å†·" : "æŒºå†·";
    public Employee this[int id] =>    // é€™å¼å”¯è®€ç´¢å¼•å­ã€‚
            this.FindEmployee(id);
}
~~~~~~~~

é¡¯ç„¶ï¼Œå°æ–¼é‚£äº›åªåŒ…å«ä¸€è¡Œç¨‹å¼ç¢¼çš„å±¬æ€§æˆ–æ–¹æ³•ï¼Œæˆ‘å€‘å¯ä»¥ç›¡é‡ä½¿ç”¨ã€Œä»¥è¡¨ç¤ºå¼ç‚ºæœ¬é«”çš„æˆå“¡ã€èªæ³•ä¾†æ’°å¯«ï¼Œè®“ç¨‹å¼ç¢¼æ›´ç°¡æ½”ä¸€äº›ã€‚

> **è¦–åŠ›æ¸¬é©—**
>
> çœ‹ä¸€ä¸‹é€™å…©è¡Œç¨‹å¼ç¢¼ï¼š
>
>        public double PI = 3.14;   // å¯è®€å¯«çš„å…¬é–‹æ¬„ä½
>        public double PI => 3.14;  // å”¯è®€çš„å…¬é–‹å±¬æ€§
>
> å…©è€…çš†å¯ç·¨è­¯ï¼Œå¯«æ³•åªå·®ä¸€å€‹å­—å…ƒï¼Œä½†æ„ç¾©å»ä¸ä¸€æ¨£ã€‚åœ¨å¯«ç¨‹å¼æˆ–å¯©é–±åˆ¥äººçš„ç¨‹å¼ç¢¼æ™‚ï¼Œçœ¼ç›å¯èƒ½å¾—çœå¤§ä¸€é»ï¼Œä»¥å…æ¼æ‰ `>` ç¬¦è™Ÿã€‚

## ç´¢å¼•åˆå§‹è¨­å®šå¼

ä»¥å¸¸ç”¨çš„ `Dictionary<TKey, TValue>` é›†åˆç‚ºä¾‹ï¼Œåœ¨ C# 6 ä¹‹å‰çš„åˆå§‹è¨­å®šå¼çš„å¯«æ³•å¦‚ä¸‹ï¼š

~~~~~~~~csharp
var weeks = new Dictionary<int, string>()
{
    {1, "æ˜ŸæœŸä¸€"},
    {2, "æ˜ŸæœŸäºŒ"},
    {3, "æ˜ŸæœŸä¸‰"}
};
~~~~~~~~

åˆ°äº† C# 6ï¼Œåªè¦é›†åˆé¡å‹æœ¬èº«æœ‰æ”¯æ´ç´¢å¼•å­ï¼Œä¾¿å¯ä½¿ç”¨ç´¢å¼•å­çš„èªæ³•ä¾†åˆå§‹åŒ–é›†åˆå…ƒç´ ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š

~~~~~~~~csharp
var weeks = new Dictionary<int, string>()
{
    [1] = "æ˜ŸæœŸä¸€",
    [2] = "æ˜ŸæœŸäºŒ",
    [3] = "æ˜ŸæœŸä¸‰"
};
~~~~~~~~

åº•ä¸‹å†å€Ÿç”¨ç¬¬ 1 ç« çš„ç¯„ä¾‹ï¼Œä½œç‚ºè£œå……ã€‚å…¶åˆå§‹è¨­å®šå¼ä½¿ç”¨äº†è‡ªè¨‚é¡åˆ¥ `Student`ï¼š

~~~~~~~~csharp
// C# 6 ä¹‹å‰
var students1 = new Dictionary<int, Student>()
{
    { 101, new Student { Name="é»ƒæ¿¤" } },
    { 102, new Student { Name="è—æ³¢" } }
}

// C# 6 ä¹‹å¾Œ
var students2 = new Dictionary<int, Student>()
{
    [101] = new Student { Name="é»ƒæ¿¤" },
    [102] = new Student { Name="è—æ³¢" }
};
~~~~~~~~

å…©ç›¸å°ç…§ï¼Œæ˜¯ä¸æ˜¯æ›´æ¸…æ¥šå®ƒå€‘åœ¨å¯«æ³•ä¸Šçš„å·®ç•°äº†å‘¢ï¼Ÿä½ å¯ä»¥é¸æ“‡è‡ªå·±å–œæ­¡çš„å¯«æ³•ã€‚

> æˆ‘æ˜¯åå¥½ç´¢å¼•å­çš„å¯«æ³•ï¼Œå› ç‚ºç¨‹å¼ç¢¼å¯ä»¥å°‘å¯«ä¸€å°å¤§æ‹¬å¼§ï¼Œçœ‹èµ·ä¾†æ›´æ¸…æ¥šã€‚

## `using static` é™³è¿°å¼

åœ¨ C# 6 ä¹‹å‰ï¼Œåªè¦æœ‰å¼•ç”¨ï¼ˆ`using`ï¼‰æŸé¡åˆ¥æ‰€å±¬çš„å‘½åç©ºé–“ï¼Œä¾¿å¯ä½¿ç”¨ã€Œé¡åˆ¥åç¨±.æˆå“¡åç¨±ã€çš„èªæ³•ä¾†å­˜å–è©²é¡åˆ¥çš„éœæ…‹æˆå“¡ã€‚ä¾‹å¦‚ï¼š

~~~~~~~~csharp
using System;      // å¼•ç”¨ System å‘½åç©ºé–“ï¼ˆçš„æ‰€æœ‰å‹åˆ¥ï¼‰
using System.IO;   // å¼•ç”¨ System.IO å‘½åç©ºé–“ï¼ˆçš„æ‰€æœ‰å‹åˆ¥ï¼‰

class BeforeCSharp6
{
    void Demo()
    {
        Console.WriteLine("Hello!");
        File.WriteAllText(@"C:\test.txt", "Hello!");
    }
}
~~~~~~~~

åˆ°äº† C# 6ï¼Œæ–°å¢çš„ `using static` é™³è¿°å¼å¯ä»¥è®“å­˜å–éœæ…‹æˆå“¡çš„å¯«æ³•æ›´ç°¡æ½”ã€‚å®ƒçš„èªæ³•æ˜¯ï¼š

    using static æŸå‹åˆ¥;

é—œéµå­— `using static` æœ¬èº«å·²ç¶“æ­ç¤ºï¼Œå…¶ç›®çš„æ˜¯è¦è®“ä½ æ›´æ–¹ä¾¿åœ°ã€Œä½¿ç”¨éœæ…‹æˆå“¡ã€ã€‚èªªå¾—æ›´æ˜ç™½äº›ï¼Œä¹Ÿå°±æ˜¯åŒ¯å…¥æŸå‹åˆ¥çš„æ‰€æœ‰éœæ…‹æˆå“¡ï¼Œä»¥ä¾¿åœ¨ç›®å‰çš„ç¨‹å¼æª”æ¡ˆä¸­ç›´æ¥ä½¿ç”¨é‚£äº›éœæ…‹æˆå“¡ï¼Œè€Œç„¡é ˆæŒ‡æ¶‰å‹åˆ¥åç¨±ã€‚

æ–¼æ˜¯ï¼Œå‰›æ‰çš„ç¯„ä¾‹å¯ä»¥æ”¹å¯«æˆé€™æ¨£ï¼š

~~~~~~~~csharp
using static System.Console;  // åŒ¯å…¥ System.Console é¡åˆ¥çš„æ‰€æœ‰éœæ…‹æˆå“¡
using static System.IO.File;  // åŒ¯å…¥ System.IO.File é¡åˆ¥çš„æ‰€æœ‰éœæ…‹æˆå“¡

class NewInCSharp6
{
    void Demo()
    {
        WriteLine("Hello!");  // çœç•¥äº† "Console."
        WriteAllText(@"C:\test.txt", "Hello!"); // çœç•¥äº† "File."
    }
}
~~~~~~~~

ä¸é›£æƒ³åƒï¼Œç•¶ä½ éœ€è¦åœ¨ç¨‹å¼ä¸­å¤§é‡å­˜å–æŸé¡åˆ¥çš„éœæ…‹æˆå“¡æ™‚ï¼Œ`using static` çš„ç¢ºå¯ä»¥è®“æˆ‘å€‘å°‘æ‰“ä¸€äº›å­—ã€‚

ä¸éï¼Œé€™å€‹æ–°å£å‘³çš„èªæ³•ç³–ææ€•ä¸è¦‹å¾—äººäººéƒ½æ„›ã€‚æ€éº¼èªªå‘¢ï¼Ÿ

è­¬å¦‚ `WriteLine` é€™é¡å¸¸è¦‹çš„æ–¹æ³•ï¼Œç”±æ–¼ä¸åªä¸€å€‹é¡åˆ¥æä¾›æ­¤æ–¹æ³•ï¼Œä½¿ç”¨æ™‚å¯èƒ½æœƒç”¢ç”Ÿåç¨±è¡çªè€Œå°è‡´ç·¨è­¯å¤±æ•—ã€‚å¦ä¸€å€‹å¯èƒ½çš„å•é¡Œæ˜¯ï¼Œå¦‚æœå¤§é‡ä½¿ç”¨ `using static` ä¾†åŒ¯å…¥è¨±å¤šé¡åˆ¥çš„éœæ…‹æˆå“¡ï¼Œé›–ç„¶å¯«ç¨‹å¼çš„æ™‚å€™å¯ä»¥å°‘æ‰“ä¸€äº›å­—ï¼Œä½†æ˜¯åœ¨é–±è®€åˆ¥äººçš„ç¨‹å¼ç¢¼çš„æ™‚å€™å¯èƒ½æœƒæœ‰ç–‘å•ï¼šé€™å€‹éœæ…‹æ–¹æ³•ï¼ˆæˆ–å±¬æ€§ï¼‰ç©¶ç«Ÿä¾†è‡ªä½•è™•ï¼Ÿ

ç„¶è€Œåœ¨æŸäº›å ´åˆï¼Œçœç•¥é¡åˆ¥åç¨±çš„å¯«æ³•å»æ˜¯åŒæ™‚å…¼å…·ç°¡æ½”ç¾è§€ã€æ˜“è®€æ˜“æ‡‚çš„å„ªé»ã€‚ä¾‹å¦‚ `Math` é¡åˆ¥ã€‚è©¦æ¯”ç…§åº•ä¸‹å…©è¡Œç¨‹å¼ç¢¼çš„å¯«æ³•ï¼š

~~~~~~~~csharp
var value1 = Math.Sqrt(Math.Sin(90) + Math.Cos(45)); // using System
var value2 = Sqrt(Sin(90) + Cos(45));     // using static System.Math
~~~~~~~~

ç¬¬ä¸€è¡Œç¨‹å¼ç¢¼æ˜¯ä¸€èˆ¬çš„éœæ…‹æ–¹æ³•å‘¼å«ã€‚ç¬¬äºŒè¡Œç¨‹å¼ç¢¼å‰‡æ˜¯ä½¿ç”¨äº† `using static` çš„å¯«æ³•ã€‚å°±æˆ‘çš„æ„Ÿè¦ºï¼Œç¬¬äºŒè¡Œç¨‹å¼ç¢¼çš„å¯«æ³•ä¸åƒ…æ›´ç°¡æ½”ï¼Œè€Œä¸”ä¸å½±éŸ¿ç¨‹å¼ç¢¼çš„ç†è§£ï¼Œç”šè‡³æ›´å®¹æ˜“é–±è®€ã€‚

> ç•¶éœæ…‹æ–¹æ³•çš„åç¨±éå¸¸æ˜ç¢ºã€æ™®éï¼Œè€Œä¸”ä¸€çœ‹å°±çŸ¥é“å®ƒçš„åŠŸç”¨èˆ‡æ‰€å±¬å‹åˆ¥ï¼Œé‚£éº¼å®ƒé€šå¸¸é©åˆä»¥ `using static` çš„æ–¹å¼åŒ¯å…¥ã€‚

å€¼å¾—ä¸€æçš„æ˜¯ï¼Œç”±æ–¼ `using static` ä½œç”¨çš„å°è±¡æ˜¯å‹åˆ¥ï¼ˆè€Œä¸æ˜¯å‘½åç©ºé–“ï¼‰ï¼Œå› æ­¤å®ƒé‚„å¯ä»¥ç”¨ä¾†é™å®šåªåŒ¯å…¥æŸé¡åˆ¥çš„æ“´å……æ–¹æ³•ï¼ˆextension methodsï¼‰ï¼Œè€Œä¸æ˜¯åƒä¸€èˆ¬çš„ `using` é™³è¿°å¼é‚£æ¨£åŒ¯å…¥æŸå‘½åç©ºé–“çš„å…¨éƒ¨æ“´å……æ–¹æ³•ã€‚ç•¶ä½ åœ¨ C# ç¨‹å¼æª”æ¡ˆä¸­ `using` äº†è¨±å¤šå‘½åç©ºé–“ï¼Œè€Œå…¶ä¸­æœ‰å…©å€‹å‘½åç©ºé–“ç¢°å·§åŒ…å«äº†ç›¸åŒåç¨±çš„æ“´å……æ–¹æ³•ï¼Œæ­¤æ™‚äº¦å¯è€ƒæ…®ä½¿ç”¨ `using static` åŒ¯å…¥æŒ‡å®šé¡åˆ¥çš„æ–¹å¼ä¾†å˜—è©¦è§£æ±ºåç¨±è¡çªçš„å•é¡Œã€‚

## ä¾‹å¤–ç¯©é¸æ¢ä»¶

åœ¨è™•ç†ä¾‹å¤–ç‹€æ³çš„æ™‚å€™ï¼Œæˆ‘å€‘å¯èƒ½æœƒæƒ³è¦é‡å°æ•æ‰åˆ°çš„ä¾‹å¤–å†é€²ä¸€æ­¥ä¾ç…§å…¶å…§éƒ¨è©³ç´°éŒ¯èª¤è³‡è¨Šä¾†åšå€‹åˆ¥è™•ç†ã€‚æ¯”å¦‚èªªï¼Œç•¶ `catch` å€å¡Šæ•æ‰åˆ°äº† `SqlException`ï¼Œæˆ‘å€‘ä¹Ÿè¨±æœƒæƒ³çŸ¥é“ï¼Œé€™æ¬¡ç™¼ç”Ÿçš„è³‡æ–™åº«æ“ä½œéŒ¯èª¤ï¼Œç©¶ç«Ÿæ˜¯å› ç‚ºä¸»éµé‡è¤‡çš„ç·£æ•…ï¼Œé‚„æ˜¯ç™¼ç”Ÿæ­»çµï¼ˆdeadlockï¼‰æˆ–å…¶ä»–åŸå› ï¼›å¦‚æœæ˜¯ä¸»éµé‡è¤‡æˆ–æ­»çµï¼Œå°±æ’°å¯«é¡å¤–çš„é‚è¼¯ä¾†è™•ç†ã€‚åœ¨ C# 6 ä¹‹å‰ï¼Œæˆ‘å€‘å¯èƒ½æœƒé€™æ¨£å¯«ï¼š

~~~~~~~~csharp
try
{
    // åŸ·è¡Œè³‡æ–™ç•°å‹•ã€‚
}
catch (SqlException ex)
{
    if (ex.Number == 2627)
    {
        // ä¸»éµé‡è¤‡!
    }
    else if (ex.Number == 1205)
    {
        // Deadlock!
    }
    else throw;
}
~~~~~~~~

å¾ C# 6 é–‹å§‹ï¼Œä¾‹å¤–è™•ç†çš„ `catch` å€å¡Šå¯ä»¥ä¸€ä½µæŒ‡å®šç¯©é¸æ¢ä»¶ï¼Œèªæ³•æ˜¯åœ¨ `catch` å¾Œé¢åŠ ä¸Šä»¥ `when` é–‹é ­çš„æ¢ä»¶å¼ï¼Œè€Œåªæœ‰ç•¶ `when` å­å¥çš„æ¢ä»¶å¼æˆç«‹æ‰æœƒé€²å…¥é‚£å€‹ `catch` å€å¡Šã€‚æ‰€ä»¥å‰›æ‰çš„ä¾‹å­å¯ä»¥æ”¹æˆï¼š

~~~~~~~~csharp
try
{
    // åŸ·è¡Œè³‡æ–™ç•°å‹•ã€‚
}
catch (SqlException ex) when (ex.Number == 2627)
{
    // ä¸»éµé‡è¤‡!
}
catch (SqlException ex) when (ex.Number == 1205)
{
    // Deadlock!
}
~~~~~~~~

é€™ç¨®å¯«æ³•çš„å¥½è™•æ˜¯å¯ä»¥æ¸›å°‘ `catch` å€å¡Šå…§çš„å·¢ç‹€æ¢ä»¶å¼ï¼Œè€Œä¸”ç¨‹å¼ç¢¼ä¹Ÿæ›´ç°¡æ½”ã€‚

ä¾‹å¤–ç¯©é¸æ¢ä»¶è£¡é¢ä¹Ÿå¯ä»¥åŒ…å«æ–¹æ³•å‘¼å«ï¼Œä¾‹å¦‚ï¼š

~~~~~~~~csharp
try
{
    // åŸ·è¡Œè³‡æ–™ç•°å‹•ã€‚
}
catch (SqlException ex) when (HandleSqlError(ex) == false)
{
    // Log and throw.
}
...

bool HandleSqlError(SqlException ex)
{
    // è‹¥å·²ç¶“è™•ç†å¥½é€™å€‹éŒ¯èª¤ï¼Œå°±å‚³å› trueï¼Œå¦å‰‡å‚³å› falseã€‚
}
~~~~~~~~

> ç¯„ä¾‹åŸå§‹ç¢¼ï¼š[DemoExceptionFilter](examples/DemoExceptionFilter)ã€‚

## `catch` å’Œ `finally` å€å¡Šä¸­çš„ `await`

åœ¨è™•ç†ä¾‹å¤–ç‹€æ³æ™‚ï¼Œä¸€ç¨®å¾ˆå¸¸è¦‹çš„å¯«æ³•æ˜¯åœ¨ `catch` æˆ– `finally` å€å¡Šä¸­æŠŠéŒ¯èª¤è¨Šæ¯ä¿å­˜è‡³æŸå€‹è¨˜éŒ„æª”ã€‚ç”±æ–¼å¯«å…¥è¨˜éŒ„æª”æ˜¯å€‹ I/O æ“ä½œï¼Œæ‰€ä»¥ä½¿ç”¨éåŒæ­¥å‘¼å«ä¹Ÿæ˜¯å¾ˆåˆç†çš„ã€‚æ–¼æ˜¯ï¼Œæˆ‘å€‘å¯èƒ½æœƒæƒ³è¦é€™æ¨£å¯«ï¼š

~~~~~~~~csharp
try
{
    ...
}
catch (Exception ex)
{
    await LogAsync(ex.Tostring()); // C# 6 OKã€‚C# 5 ç·¨è­¯å¤±æ•—!
}
~~~~~~~~

è‹¥ä½¿ç”¨ C# 5 æˆ–æ›´æ—©ç‰ˆæœ¬çš„ç·¨è­¯å™¨ï¼Œå€’æ•¸ç¬¬äºŒè¡Œæœƒå‡ºç¾ç·¨è­¯éŒ¯èª¤ï¼š"Cannot await a catch clause."ï¼Œä¹Ÿå°±æ˜¯ `catch` å­å¥ä¸­ä¸å¯ä½¿ç”¨ `await`ã€‚C# 6 å‰‡è§£é™¤äº†é€™å€‹é™åˆ¶ï¼Œè®“ `catch` å’Œ `finally` å€å¡Šè£¡é¢éƒ½å¯ä»¥å¯« `await` é™³è¿°å¼ã€‚

åº•ä¸‹æ˜¯ä¸€å€‹æ¯”è¼ƒå®Œæ•´çš„ç¯„ä¾‹ï¼š

~~~~~~~~csharp
using System;
using System.IO;
using System.Threading.Tasks;
...

static async Task<string> HttpGetStrAsync(string url)
{
    var client = new System.Net.Http.HttpClient();
    var streamTask = client.GetStringAsync(url);
    try
    {
        var responseText = await streamTask;
        return responseText;
    }
    catch (System.Net.Http.HttpRequestException ex)
    {
        await LogAsync($"å¤±æ•—: {ex.Message}");
        return ex.Message;
    }
    finally
    {
        client.Dispose();
        await LogAsync("é›¢é–‹ HttpGHetAsync() æ–¹æ³•ã€‚");
    }
}

static async Task LogAsync(string s)
{
    await File.AppendAllTextAsync(@"c:\temp\log.txt", s);
}
~~~~~~~~

é †ä¾¿æåŠï¼Œå¯¦å‹™ä¸Šï¼Œç”¨ä¾†ä¿å­˜è¨˜éŒ„çš„ `LogAsync` å‡½å¼ä¸æ‡‰è©²å†æ‹‹å‡ºä¾‹å¤–ï¼Œå¦å‰‡å¤–å±¤çš„ `catch` å€å¡Šåˆæœƒå†æ¬¡æ‹‹å‡ºæ–°çš„ä¾‹å¤–ï¼Œé‚£éº¼ç¬¬ 18 è¡Œç”¨ä¾†è¿”å›éŒ¯èª¤è¨Šæ¯çš„é™³è¿°å¼å°±åŸ·è¡Œä¸åˆ°äº†ï¼›ä¹Ÿå°±æ˜¯èªªï¼ŒåŸæœ¬è¦è¨˜éŒ„ä¸‹ä¾†çš„ä¾‹å¤–æœƒè¢«ä¸Ÿæ£„ï¼Œè‹¥å°‡ä¾†è¦èª¿é–±è¨˜éŒ„æª”æ¡ˆä¾†æŸ¥å•é¡Œï¼Œæœƒæ‰¾ä¸åˆ°ç›¸é—œç·šç´¢ã€‚

> ç¯„ä¾‹åŸå§‹ç¢¼ï¼š[DemoExceptionAwait](examples/DemoExceptionAwait)ã€‚

---

ï½ENDï½

â¬†ï¸[å›é ‚ç«¯](https://github.com/huanlin/LearningNotes/blob/main/csharp6/_post.md#c-6)
â†©ï¸[å›é¦–é ](https://github.com/huanlin/LearningNotes#readme)
